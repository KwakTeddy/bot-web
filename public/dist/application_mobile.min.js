"use strict";function appRun($rootScope,$state,Authentication){function storePreviousState(state,params){state.data&&state.data.ignoreState||($state.previous={state:state,params:params,href:$state.href(state,params)})}$rootScope.$on("$stateChangeStart",function(event,toState,toParams,fromState,fromParams){if(toState.data&&toState.data.roles&&toState.data.roles.length>0){var allowed=!1;if(toState.data.roles.forEach(function(role){if(void 0!==Authentication.user.roles&&Authentication.user.roles.indexOf(role)!==-1)return allowed=!0,!0}),!allowed){event.preventDefault();var stingParser=$state.current.name,parsedString=stingParser.split(".");void 0!==Authentication.user&&"object"==typeof Authentication.user?"user-bots-web"==parsedString[0]?$state.go("user-bots-web.forbidden"):$state.go("forbidden"):$state.go("authentication.signin").then(function(){storePreviousState(toState,toParams)})}}if(toState.name.indexOf("authentication")!=-1||toState.name.indexOf("password")!=-1){var userbotHeader=document.getElementById("mainHeader"),userbotChat=document.getElementById("container-chat");userbotHeader&&userbotChat&&(document.getElementById("mainHeader").style.display="none",document.getElementById("container-chat").style.display="none")}else{var userbotHeader=document.getElementById("mainHeader"),userbotChat=document.getElementById("container-chat");userbotHeader&&userbotChat&&(document.getElementById("mainHeader").style.display="block",document.getElementById("container-chat").style.display="block")}}),$rootScope.$on("$stateChangeSuccess",function(event,toState,toParams,fromState,fromParams){storePreviousState(fromState,fromParams)})}function getUserBots(UserBotsService,UserBotsFollowService,$stateParams,$location){return $stateParams.listType?"popular"==$stateParams.listType?UserBotsService.query({sort:"-followed"}).$promise:"followed"==$stateParams.listType?UserBotsFollowService.list({botUserId:$stateParams.botUserId}).$promise:"my"==$stateParams.listType?UserBotsService.query({my:"1"}).$promise:UserBotsService.query().$promise:UserBotsService.query().$promise}function getUserBot(UserBotsService,$stateParams){return UserBotsService.get({userBotId:$stateParams.userBotId}).$promise}function newUserBot(UserBotsService){return new UserBotsService}function getMyInvestments(InvestmentsMyService){return InvestmentsMyService.query().$promise}function getInvestmentUserExt(UsersExtService,Authentication){return UsersExtService.get({userId:Authentication.user._id}).$promise}function clearBubble(){document.getElementById("chat_main").innerText="",document.chatForm.inputbox.value=""}function addBotBubble(msg){var main=document.getElementById("chat_main"),bubble=document.createElement("div");bubble.setAttribute("class","bubble"),bubble.innerText=msg,main.appendChild(bubble),main.scrollTop=main.scrollHeight-main.clientHeight}function addUserBubble(msg){var main=document.getElementById("chat_main"),bubble=document.createElement("div");bubble.setAttribute("class","bubble bubble--alt"),bubble.innerText=msg,main.appendChild(bubble),document.chatForm.inputbox.value="",main.scrollTop=main.scrollHeight-main.clientHeight}function synthesize(message){var utterance=new SpeechSynthesisUtterance(message);utterance.lang="ko-KR",utterance.onstart=function(event){console.log("synthesize start")},utterance.onerror=function(event){console.log("synthesize error")},utterance.onend=function(event){console.log("synthesize end")},window.speechSynthesis.speak(utterance)}function clearBubble(){document.getElementById("chat_main").innerText="",document.chatForm.inputbox.value=""}function addBotBubble(msg){var main=document.getElementById("chat_main"),bubble=document.createElement("div");bubble.setAttribute("class","bubble"),bubble.innerText=msg,main.appendChild(bubble),main.scrollTop=main.scrollHeight-main.clientHeight}function addUserBubble(msg){var main=document.getElementById("chat_main"),bubble=document.createElement("div");bubble.setAttribute("class","bubble bubble--alt"),bubble.innerText=msg,main.appendChild(bubble),document.chatForm.inputbox.value="",main.scrollTop=main.scrollHeight-main.clientHeight}function synthesize(message){var utterance=new SpeechSynthesisUtterance(message);utterance.lang="ko-KR",utterance.onstart=function(event){console.log("synthesize start")},utterance.onerror=function(event){console.log("synthesize error")},utterance.onend=function(event){console.log("synthesize end")},window.speechSynthesis.speak(utterance)}function clearBubble(){document.getElementById("chat_main").innerText="",document.chatForm.inputbox.value=""}function addBotBubble(msg){var main=document.getElementById("chat_main"),bubble=document.createElement("div");if(bubble.setAttribute("class","bubble"),msg.startsWith("{")){var json=JSON.parse(msg);bubble.innerText=json.text,json.url&&(json.urlMessage?bubble.innerHTML+='\n<br/><a href="'+json.url+'" target="_blank">'+json.urlMessage+"</a>":bubble.innerHTML+='\n<br/><a href="'+json.url+'" target="_blank">'+json.url+"</a>")}else bubble.innerText=msg;main.appendChild(bubble),main.scrollTop=main.scrollHeight-main.clientHeight}function addUserBubble(msg){var main=document.getElementById("chat_main"),bubble=document.createElement("div");bubble.setAttribute("class","bubble bubble--alt"),bubble.innerText=msg,main.appendChild(bubble),document.chatForm.inputbox.value="",main.scrollTop=main.scrollHeight-main.clientHeight}function synthesize(message){var utterance=new SpeechSynthesisUtterance(message);utterance.lang="ko-KR",utterance.onstart=function(event){console.log("synthesize start")},utterance.onerror=function(event){console.log("synthesize error")},utterance.onend=function(event){console.log("synthesize end")},window.speechSynthesis.speak(utterance)}function merge(source1,source2){if(source1||source2){if(!source1&&source2)return source2;if(source1&&!source2)return source1;for(var attrname in source2)source1[attrname]||(source2[attrname].constructor==Object?source1[attrname]=clone(source2[attrname]):source1[attrname]=source2[attrname]);return source1}}function clone(obj){var copy;if(null==obj||"object"!=typeof obj)return obj;if(obj instanceof Date)return copy=new Date,copy.setTime(obj.getTime()),copy;if(obj instanceof RegExp)return obj;if(obj instanceof Array){copy=[];for(var i=0,len=obj.length;i<len;i++)copy[i]=clone(obj[i]);return copy}if(obj instanceof Object){copy={};for(var attr in obj)obj.hasOwnProperty(attr)&&(copy[attr]=clone(obj[attr]));return copy}throw new Error("Unable to copy obj! Its type isn't supported.")}function merge(source1,source2){if(source1||source2){if(!source1&&source2)return source2;if(source1&&!source2)return source1;for(var attrname in source2)source1[attrname]||(source2[attrname].constructor==Object?source1[attrname]=clone(source2[attrname]):source1[attrname]=source2[attrname]);return source1}}function clone(obj){var copy;if(null==obj||"object"!=typeof obj)return obj;if(obj instanceof Date)return copy=new Date,copy.setTime(obj.getTime()),copy;if(obj instanceof RegExp)return obj;if(obj instanceof Array){copy=[];for(var i=0,len=obj.length;i<len;i++)copy[i]=clone(obj[i]);return copy}if(obj instanceof Object){copy={};for(var attr in obj)obj.hasOwnProperty(attr)&&(copy[attr]=clone(obj[attr]));return copy}throw new Error("Unable to copy obj! Its type isn't supported.")}function merge(source1,source2){if(source1||source2){if(!source1&&source2)return source2;if(source1&&!source2)return source1;for(var attrname in source2)source1[attrname]||(source2[attrname].constructor==Object?source1[attrname]=clone(source2[attrname]):source1[attrname]=source2[attrname]);return source1}}function clone(obj){var copy;if(null==obj||"object"!=typeof obj)return obj;if(obj instanceof Date)return copy=new Date,copy.setTime(obj.getTime()),copy;if(obj instanceof RegExp)return obj;if(obj instanceof Array){copy=[];for(var i=0,len=obj.length;i<len;i++)copy[i]=clone(obj[i]);return copy}if(obj instanceof Object){copy={};for(var attr in obj)obj.hasOwnProperty(attr)&&(copy[attr]=clone(obj[attr]));return copy}throw new Error("Unable to copy obj! Its type isn't supported.")}var ApplicationConfiguration=function(){var applicationModuleVendorDependencies,applicationModuleName="mean";return applicationModuleVendorDependencies="mobile"==_platform?["ng","ngResource","ngAnimate","ngMessages","ngCookies","ui.router","ui.bootstrap","ui.bootstrap.modal","ui.utils","ionic"]:["ngResource","ngAnimate","ngMessages","ngCookies","ui.router","ui.bootstrap","ui.utils","angularFileUpload","datatables","ui.codemirror","ui.select","ngSanitize","ngDropzone"],{applicationModuleName:applicationModuleName,applicationModuleVendorDependencies:applicationModuleVendorDependencies,registerModule:function(moduleName,dependencies){angular.module(moduleName,dependencies||[]),angular.module(applicationModuleName).requires.push(moduleName)}}}();angular.module(ApplicationConfiguration.applicationModuleName,ApplicationConfiguration.applicationModuleVendorDependencies),angular.module(ApplicationConfiguration.applicationModuleName).config(["$locationProvider","$httpProvider",function($locationProvider,$httpProvider){"web"==_platform&&$locationProvider.html5Mode(!0).hashPrefix("!"),$httpProvider.interceptors.push("authInterceptor"),$httpProvider.defaults.cache=!1,$httpProvider.defaults.headers.get||($httpProvider.defaults.headers.get={}),$httpProvider.defaults.headers.get["If-Modified-Since"]="0",$httpProvider.defaults.headers.get["Cache-Control"]="no-cache",$httpProvider.defaults.headers.get.Pragma="no-cache"}]),"mobile"==_platform&&angular.module(ApplicationConfiguration.applicationModuleName).config(["$ionicConfigProvider",function($ionicConfigProvider){$ionicConfigProvider.backButton.previousTitleText(!1).text("뒤로")}]),"mobile"==_platform?angular.module(ApplicationConfiguration.applicationModuleName).run(["$rootScope","$state","Authentication","$ionicPlatform","$ionicLoading","$ionicHistory",function($rootScope,$state,Authentication,$ionicPlatform,$ionicLoading,$ionicHistory){$rootScope.$on("$stateChangeStart",function(event,toState,toParams,fromState,fromParams){var allowed=!0;toState.data&&toState.data.roles&&toState.data.roles.length>0&&(allowed=!1,toState.data.roles.forEach(function(role){("guest"===role||Authentication.user&&void 0!==Authentication.user.roles&&Authentication.user.roles.indexOf(role)!==-1)&&(allowed=!0)})),allowed&&"mobile.companies.view"!=toState.name&&"mobile.companies.list"!=toState.name&&$ionicLoading.show({noBackdrop:!0})}),$rootScope.$on("$stateChangeSuccess",function(){$ionicLoading.hide()}),appRun($rootScope,$state,Authentication),$ionicPlatform.ready(function(){if(ionic.Platform.isIOS()||ionic.Platform.isIPad()?_os="ios":ionic.Platform.isAndroid()?_os="android":_os="web",console.log("Platform Ready : "+_platform+"("+_os+")"),("ios"==_os||"android"==_os)&&"defined"==typeof PushNotification){var push=PushNotification.init({android:{senderID:"930230456352"},ios:{alert:"true",badge:"true",sound:"true"},windows:{}});push.on("registration",function(data){console.log("PUSH registered : "+data.registrationId)}),push.on("notification",function(data){console.log("PUSH : "+data.message)}),push.on("error",function(e){console.log("PUSH error : "+e.message)})}})}]):angular.module(ApplicationConfiguration.applicationModuleName).run(["$rootScope","$state","Authentication",function($rootScope,$state,Authentication){appRun($rootScope,$state,Authentication)}]),angular.element(document).ready(function(){if(window.location.hash&&"#_=_"===window.location.hash)if(window.history&&history.pushState)"mobile"==_platform?window.history.pushState("",document.title,window.location.pathname+"?_p=m"):window.history.pushState("",document.title,window.location.pathname);else{var scroll={top:document.body.scrollTop,left:document.body.scrollLeft};window.location.hash="",document.body.scrollTop=scroll.top,document.body.scrollLeft=scroll.left}angular.bootstrap(document,[ApplicationConfiguration.applicationModuleName])}),function(app){app.registerModule("analytics")}(ApplicationConfiguration),ApplicationConfiguration.registerModule("articles"),function(app){app.registerModule("banks")}(ApplicationConfiguration),function(app){app.registerModule("bot-users")}(ApplicationConfiguration),ApplicationConfiguration.registerModule("bots"),ApplicationConfiguration.registerModule("user-bots",["infinite-scroll","ionic"]),function(app){app.registerModule("campaigns")}(ApplicationConfiguration),function(app){app.registerModule("canonicals")}(ApplicationConfiguration),ApplicationConfiguration.registerModule("chat"),function(app){app.registerModule("common-actions")}(ApplicationConfiguration),function(app){app.registerModule("concepts")}(ApplicationConfiguration),"mobile"==_platform?ApplicationConfiguration.registerModule("core",["ionic","messengers"]):ApplicationConfiguration.registerModule("core"),ApplicationConfiguration.registerModule("core.admin",["core"]),ApplicationConfiguration.registerModule("core.admin.routes",["ui.router"]),function(app){app.registerModule("custom-actions")}(ApplicationConfiguration),function(app){app.registerModule("deliveryOrders")}(ApplicationConfiguration),function(app){app.registerModule("dialogsets")}(ApplicationConfiguration),function(app){app.registerModule("dicts")}(ApplicationConfiguration),function(app){app.registerModule("facts")}(ApplicationConfiguration),function(app){app.registerModule("faqs")}(ApplicationConfiguration),function(app){app.registerModule("franchises")}(ApplicationConfiguration),ApplicationConfiguration.registerModule("learnings"),function(app){app.registerModule("messages")}(ApplicationConfiguration),ApplicationConfiguration.registerModule("messengers"),function(app){app.registerModule("products")}(ApplicationConfiguration),function(app){app.registerModule("restaurants")}(ApplicationConfiguration),function(app){app.registerModule("user-dialogs")}(ApplicationConfiguration),ApplicationConfiguration.registerModule("users",["core"]),ApplicationConfiguration.registerModule("users.admin",["core.admin"]),ApplicationConfiguration.registerModule("users.admin.routes",["core.admin.routes"]),function(){function routeConfig($stateProvider){$stateProvider.state("user-bots",{abstract:!0,url:""}).state("homeMobile",{url:"/",views:{"menuContent@":{templateUrl:"modules/bots/client/views/list-user-bots.mobile.view.html",controllerAs:"vm",controller:"UserBotListController",resolve:{userBotsResolve:getUserBots}}}}).state("user-bots.list",{url:"/list?listType&query",views:{"menuContent@":{templateUrl:"modules/bots/client/views/list-user-bots.mobile.view.html",controllerAs:"vm",controller:"UserBotListController",resolve:{userBotsResolve:getUserBots}}}}).state("user-bots.chat",{url:"/chat/:userBotId",views:{"menuContent@":{templateUrl:"modules/bots/client/views/chat-user-bot.mobile.view.html",controllerAs:"vm",controller:"UserBotChatController"}}})}angular.module("user-bots").config(routeConfig),routeConfig.$inject=["$stateProvider"]}(),getUserBots.$inject=["UserBotsService","UserBotsFollowService","$stateParams","$location"],getUserBot.$inject=["UserBotsService","$stateParams"],newUserBot.$inject=["UserBotsService"],angular.module("core").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$stateProvider.state("mobile",{abstract:!0}),$urlRouterProvider.otherwise("/")}]),getMyInvestments.$inject=["InvestmentsMyService"],getInvestmentUserExt.$inject=["UsersExtService","Authentication"],function(){function routeConfig($stateProvider){$stateProvider.state("mobile.messengers",{abstract:!0,url:"/messengers"}).state("mobile.messengers.list",{url:"",views:{"menuContent@":{templateUrl:"modules/messengers/client/views/list-messengers.mobile.view.html",controllerAs:"vm"}}}).state("mobile.messengers.chat",{url:"/chat",views:{"menuContent@":{templateUrl:"modules/messengers/client/views/chat-messengers.mobile.view.html",controllerAs:"vm",controller:"ChatMessengersController"}}})}angular.module("messengers").config(routeConfig),routeConfig.$inject=["$stateProvider"]}(),angular.module("analytics").controller("AnalyticsListController",["$scope","$rootScope","$stateParams","$location","$window","Authentication","AnalyticsService","DialogUsageService","DialogSuccessService","SessionSuccessService","DialogFailureService","Dialogs","DialogChildren",function($scope,$rootScope,$stateParams,$location,$window,Authentication,AnalyticsService,DialogUsageService,DialogSuccessService,SessionSuccessService,DialogFailureService,Dialogs,DialogChildren){$scope.authentication=Authentication,$scope.kind="all",$scope.year=(new Date).getFullYear(),$scope.ym=new Date,$scope.find=function(){var arg="empty";"year"==$scope.kind?arg=$scope.year:"month"==$scope.kind&&(arg=$scope.ym);var userCounts=AnalyticsService.query({kind:$scope.kind,arg:arg},function(){console.log(userCounts),$scope.userCounts=userCounts},function(err){console.log(err)})},$scope.find_dialog=function(){var arg="empty";"year"==$scope.kind?arg=$scope.year:"month"==$scope.kind&&(arg=$scope.ym);var dialogUsages=DialogUsageService.query({kind:$scope.kind,arg:arg},function(){$scope.dialogUsages=dialogUsages},function(err){console.log(err)})},$scope.find_dialog_success=function(){var arg="empty";"year"==$scope.kind?arg=$scope.year:"month"==$scope.kind&&(arg=$scope.ym);var dialogSuccess=DialogSuccessService.query({kind:$scope.kind,arg:arg},function(){console.log(dialogSuccess),$scope.dialogSuccess=dialogSuccess},function(err){console.log(err)})},$scope.find_session_success=function(){var arg="empty";"year"==$scope.kind?arg=$scope.year:"month"==$scope.kind&&(arg=$scope.ym);var sessionSuccess=SessionSuccessService.query({kind:$scope.kind,arg:arg},function(){$scope.sessionSuccess=sessionSuccess},function(err){console.log(err)})},$scope.addInput=function(){$scope.dialog.inputs.push({str:""})},$scope.addOutput=function(){$scope.dialog.outputs.push({str:""})};var makeStr=function(obj){return Array.isArray(obj)?obj.map(function(o){return{str:o}}):[{str:obj}]},unMake=function(obj){if(Array.isArray(obj))return obj.map(function(o){return o.str})};$scope.findOne=function(dialogId,newDialog){var botId=$rootScope.botId;$scope.dialog={botId:botId,dialogId:dialogId};var dialog=Dialogs.get({botId:botId,dialogId:dialogId},function(){$scope.dialog.name=dialog.name,$scope.dialog.inputs=makeStr(dialog.inputs),$scope.dialog.outputs=makeStr(dialog.outputs),$scope.dialog.inputs.push({str:newDialog}),$(".modal-with-form").click()})},$scope.findChildren=function(dialogId,newDialog){var botId=$rootScope.botId,dialogs=DialogChildren.query({botId:botId,dialogId:dialogId},function(){console.log(dialogs),dialogs.forEach(function(obj,i){obj.idx=i,obj.inputs=makeStr(obj.inputs),obj.outputs=makeStr(obj.outputs),obj.inputs.push({str:newDialog})}),$scope.dialogs=dialogs,$scope.selected=$scope.dialogs[0],$(".modal-with-form").click()},function(err){console.log(err)})},$scope.update=function(isValid){if($scope.error=null,!isValid)return $scope.$broadcast("show-errors-check-validity","dialogForm"),!1;var dialog=$scope.selected;dialog.botId=$rootScope.botId,dialog.inputs=unMake(dialog.inputs),dialog.outputs=unMake(dialog.outputs),console.log(JSON.stringify(dialog)),Dialogs.update(dialog)},$scope.find_dialog_failure=function(){var arg="empty";"year"==$scope.kind?arg=$scope.year:"month"==$scope.kind&&(arg=$scope.ym);var dialogFailure=DialogFailureService.query({kind:$scope.kind,arg:arg},function(){console.log(dialogFailure),$scope.dialogFailure=dialogFailure},function(err){console.log(err)})},$scope.dashboard=function(){$scope.find_dialog();var userCounts=AnalyticsService.query({kind:"all",arg:"empty"},function(){console.log(userCounts);for(var val=[],i=0;i<userCounts.length&&i<10;++i)val.unshift([userCounts[i]._id.month+"/"+userCounts[i]._id.date,userCounts[i].count]);drawFlot([{data:val,color:"#0088cc"}])},function(err){console.log(err)}),dialogSuccess=DialogSuccessService.query({kind:"all",arg:"empty"},function(){console.log(dialogSuccess);for(var val=[],i=0;i<dialogSuccess.length&&i<10;++i)val.unshift({y:dialogSuccess[i]._id.month+"/"+dialogSuccess[i]._id.date,a:dialogSuccess[i].success_count,b:dialogSuccess[i].fail_count});console.log(val),drawBar(val)},function(err){console.log(err)}),calcRate=function(list){var success=0,fail=0;return list.forEach(function(obj){success+=obj.success_count,fail+=obj.fail_count}),(success-fail)/success*100},dialogSuccessYear=DialogSuccessService.query({kind:"year",arg:$scope.year},function(){console.log(dialogSuccessYear),drawLiquid("#meterYear",calcRate(dialogSuccessYear),"#0088cc")},function(err){console.log(err)}),dialogSuccessMonth=DialogSuccessService.query({kind:"month",arg:$scope.ym},function(){console.log(dialogSuccessMonth),drawLiquid("#meterMonth",calcRate(dialogSuccessMonth),"#2baab1")},function(err){console.log(err)})};var drawFlot=function(flotUserData){(function($){$.plot("#flotUser",flotUserData,{series:{lines:{show:!0,lineWidth:2},points:{show:!0},shadowSize:0},grid:{hoverable:!0,clickable:!0,borderColor:"rgba(0,0,0,0.1)",borderWidth:1,labelMargin:15,backgroundColor:"transparent"},yaxis:{min:0,color:"rgba(0,0,0,0.1)"},xaxis:{mode:"categories",color:"rgba(0,0,0,0)"},legend:{show:!1},tooltip:!0,tooltipOpts:{content:"%x: %y",shifts:{x:-30,y:25},defaultTheme:!1}})}).apply(this,[jQuery])},drawLiquid=function(name,value,color){$(name)[0].value=parseInt(value,10),function($){$(name).liquidMeter({shape:"circle",color:color,background:"#F9F9F9",fontSize:"24px",fontWeight:"600",stroke:"#F2F2F2",textColor:"#333",liquidOpacity:.9,liquidPalette:["#333"],speed:3e3,animate:!$.browser.mobile})}.apply(this,[jQuery])},drawBar=function(barData){(function($){Morris.Bar({resize:!0,element:"morrisStacked",data:barData,xkey:"y",ykeys:["a","b"],labels:["성공","실패"],barColors:["#0088cc","#2baab1"],fillOpacity:.7,smooth:!1,stacked:!0,hideHover:!0})}).apply(this,[jQuery])}}]),angular.module("articles").controller("ArticlesController",["$scope","$stateParams","$location","Authentication","Articles",function($scope,$stateParams,$location,Authentication,Articles){$scope.authentication=Authentication,$scope.create=function(isValid){if($scope.error=null,!isValid)return $scope.$broadcast("show-errors-check-validity","articleForm"),!1;new Articles({title:this.title,content:this.content}).$save(function(response){$location.path("articles/"+response._id),$scope.title="",$scope.content=""},function(errorResponse){$scope.error=errorResponse.data.message})},$scope.remove=function(article){if(article){article.$remove();for(var i in $scope.articles)$scope.articles[i]===article&&$scope.articles.splice(i,1)}else $scope.article.$remove(function(){$location.path("articles")})},$scope.update=function(isValid){if($scope.error=null,!isValid)return $scope.$broadcast("show-errors-check-validity","articleForm"),!1;var article=$scope.article;article.$update(function(){$location.path("articles/"+article._id)},function(errorResponse){$scope.error=errorResponse.data.message})},$scope.find=function(){$scope.articles=Articles.query()},$scope.findOne=function(){$scope.article=Articles.get({articleId:$stateParams.articleId})}}]),function(){function BanksController($scope,$state,Authentication,bank){function remove(){confirm("Are you sure you want to delete?")&&vm.bank.$remove($state.go("banks.list"))}function save(isValid){function successCallback(res){$state.go("banks.view",{bankId:res._id})}function errorCallback(res){vm.error=res.data.message}if(!isValid)return $scope.$broadcast("show-errors-check-validity","vm.form.bankForm"),!1;vm.bank._id?vm.bank.$update(successCallback,errorCallback):vm.bank.$save(successCallback,errorCallback)}var vm=this;vm.authentication=Authentication,vm.bank=bank,vm.error=null,vm.form={},vm.remove=remove,vm.save=save}angular.module("banks").controller("BanksController",BanksController),BanksController.$inject=["$scope","$state","Authentication","bankResolve"]}(),function(){function BanksListController(BanksService){this.banks=BanksService.query()}angular.module("banks").controller("BanksListController",BanksListController),BanksListController.$inject=["BanksService"]}(),function(){function BankSaveController($scope,$state,BanksService){var vm=this;vm.BANKS=[{bankName:"신한",bankCode:"88"},{bankName:"농협",bankCode:"11"},{bankName:"하나",bankCode:"81"},{bankName:"우리",bankCode:"20"},{bankName:"국민",bankCode:"04"},{bankName:"기업",bankCode:"03"},{bankName:"대구",bankCode:"31"},{bankName:"씨티",bankCode:"27"},{bankName:"SC제일",bankCode:"23"},{bankName:"새마을",bankCode:"45"}],vm.init=function(){BanksService.query({userKey:userKey},function(banks,err){vm.banks=banks,angular.forEach(vm.banks,function(bank){for(var i=0;i<$scope.BANKS.length;i++)if(bank.bankCode==$scope.BANKS[i].bankCode){$scope.BANKS[i]=bank;break}})})},vm.bank={},vm.error=null,vm.form={},vm.selectBank=function(bank){vm.bank=bank,vm.bank.userID=null,vm.bank.userPassword=null},vm.save=function(valid){function successCallback(res){vm.error="저장되었습니다. 상단 뒤로가기로 카카오톡으로 돌아가 주세요"}function errorCallback(res){vm.error=res.data.message}valid&&(vm.bank._id?vm.bank.$save({userKey:userKey},successCallback,errorCallback):new BanksService(vm.bank).$save({userKey:userKey},successCallback,errorCallback))}}angular.module("banks").controller("BankSaveController",BankSaveController),BankSaveController.$inject=["$scope","$state","BanksService"]}(),function(){function BotUsersController($scope,$state,Authentication,BotUsersService,botUser){function remove(){confirm("Are you sure you want to delete?")&&vm.botUser.$remove($state.go("bot-users.list"))}function save(isValid){function successCallback(res){vm.error="생성되었습니다 : "+vm.botUser.name,vm.botUser=new BotUsersService}function errorCallback(res){vm.error=res.data.message}if(!isValid)return $scope.$broadcast("show-errors-check-validity","vm.form.botUserForm"),!1;vm.botUser._id?vm.botUser.$update(successCallback,errorCallback):vm.botUser.$save(successCallback,errorCallback)}var vm=this;vm.channels=["카카오톡","라인","페이스북"],vm.authentication=Authentication,vm.botUser=botUser,vm.error=null,vm.form={},vm.remove=remove,vm.save=save,vm.botUser.channel||(vm.botUser.channel=vm.channels[0]),vm.randomCreate=function(){vm.botUser.userKey=randomString(10),vm.botUser.channel=vm.channels[Math.floor(Math.random()*vm.channels.length)],vm.botUser.name=randomString(Math.floor(4*Math.random())+4),vm.botUser.phone="010-"+randomNumber(4)+"-"+randomNumber(4),vm.botUser.email=vm.botUser.name+randomEmail(),vm.botUser.isOn=0==Math.floor(2*Math.random())};var randomString=function(length){for(var text="",possible="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=0;i<length;i++)text+=possible.charAt(Math.floor(Math.random()*possible.length));return text},randomNumber=function(length){for(var text="",possible="0123456789",i=0;i<length;i++)text+=possible.charAt(Math.floor(Math.random()*possible.length));return text},randomEmail=function(){var emails=["@gmail.com","@moneybrain.com","@finger.co.kr","@naver.com"];return emails[Math.floor(Math.random()*emails.length)]}}angular.module("bot-users").controller("BotUsersController",BotUsersController),BotUsersController.$inject=["$scope","$state","Authentication","BotUsersService","botUserResolve"]}(),function(){function BotUsersListController(botUsers){this.botUsers=botUsers}angular.module("bot-users").controller("BotUsersListController",BotUsersListController),BotUsersListController.$inject=["botUsersResolve"]}(),angular.module("user-bots").controller("AnalyticsController",["$scope","$rootScope","$state","$window","$timeout","$stateParams","$resource","Authentication",function($scope,$rootScope,$state,$window,$timeout,$stateParams,$resource,Authentication){var vm=this;vm.user=Authentication.user,vm.userId=$rootScope.userId,vm.context={botUser:{}},vm.type="",$state.is("user-bots-web.create")?(vm.state="create",vm.type="edit"):$state.is("user-bots-web.edit")?(vm.state="edit",vm.type="edit"):$state.is("user-bots-web.view")&&(vm.state="view",vm.type="view"),vm.changeType=function(type){vm.type=type};var timer=null;$scope.$on("keyinput",function(event,arg0){null==timer&&(timer=setTimeout(function(){var input=arg0;$resource("/api/user-bots-analytics/context",{}).get({input:input,botId:$rootScope.botId,botUser:$rootScope.botId+"_"+$rootScope.userId,dialogsets:$rootScope.userBot.dialogsets},function(res){if(Array.isArray(res.result)?vm.dialogs=res.result:vm.dialogs=[res.result],vm.context=res.context,vm.topic="",vm.context.botUser&&void 0!=vm.context.botUser.topic)for(var i=0;i<vm.context.botUser.topic.length;i++)vm.topic+=vm.context.botUser.topic[i].text+" ";if(vm.nlp="",vm.context.botUser&&void 0!=vm.context.botUser.nlp)for(var i=0;i<vm.context.botUser.nlp.length;i++)vm.nlp+=vm.context.botUser.nlp[i].text+" ";res.result?Array.isArray(res.result)?vm.best=res.result[0]:vm.best=res.result:vm.best=void 0,timer=null})},300))})}]),angular.module("bots").controller("BotController",["$scope","$state","$stateParams","botResolve","BotsService",function($scope,$state,$stateParams,bot,BotsService){var vm=this;vm.bot=bot,vm.create=function(isValid){if($scope.error=null,!isValid)return $scope.$broadcast("show-errors-check-validity","botForm"),!1;vm.bot.$save(function(response){$state.go("bots.list")},function(errorResponse){$scope.error=errorResponse.data.message})},vm.remove=function(){vm.bot&&vm.bot._id&&vm.bot.$remove(function(){$state.go("bots.list")},function(errorResponse){$scope.error=errorResponse.data.message})},vm.update=function(isValid){if($scope.error=null,!isValid)return $scope.$broadcast("show-errors-check-validity","botForm"),!1;vm.bot&&vm.bot._id&&vm.bot.$update(function(){$state.go("bots.list")},function(errorResponse){$scope.error=errorResponse.data.message})}}]),angular.module("bots").controller("BotFilesController",["$scope","$stateParams","botResolve","botFilesResolve","BotFilesService","CoreUtils",function($scope,$stateParams,bot,files,BotFilesService,CoreUtils){var vm=this;vm.bot=bot,vm.files=files,vm.addFileName="",vm.remove=function(index){CoreUtils.showYesOrNoAlert("정말 지우시겠습니까?",function(){vm.files[index].$remove({botId:vm.files[index].bot._id},function(res){vm.files.splice(index,1)},function(err){CoreUtils.showConfirmAlert(err.data.message)})})},vm.create=function(){vm.addFileName&&vm.addFileName.length>0&&new BotFilesService({botId:vm.bot._id,fileName:vm.addFileName}).$save(function(botFile){vm.files.push(botFile)},function(err){CoreUtils.showConfirmAlert(err.data.message)})},vm.rename=function(index){vm.files[index].$update({botId:vm.files[index].bot._id},function(file){vm.files.splice(index,1,file)},function(err){CoreUtils.showConfirmAlert(err.data.message)})},vm.edit=function(index,edit){vm.files[index].edit=edit,edit&&(vm.files[index].renameFileName=vm.files[index].name)}}]),angular.module("user-bots").controller("UserBotFilesController",["$scope","$stateParams","userBotResolve","userBotFilesResolve","UserBotFilesService","CoreUtils",function($scope,$stateParams,userBot,files,UserBotFilesService,CoreUtils){var vm=this;vm.userBot=userBot,vm.files=files,vm.addFileName="",vm.remove=function(index){CoreUtils.showYesOrNoAlert("정말 지우시겠습니까?",function(){vm.files[index].$remove({userBotId:vm.files[index].userBot._id},function(res){vm.files.splice(index,1)},function(err){CoreUtils.showConfirmAlert(err.data.message)})})},vm.create=function(){vm.addFileName&&vm.addFileName.length>0&&new UserBotFilesService({userBotId:vm.userBot._id,fileName:vm.addFileName}).$save(function(userBotFile){vm.files.push(userBotFile)},function(err){CoreUtils.showConfirmAlert(err.data.message)})},vm.rename=function(index){vm.files[index].$update({userBotId:vm.files[index].userBot._id},function(file){vm.files.splice(index,1,file)},function(err){CoreUtils.showConfirmAlert(err.data.message)})},vm.edit=function(index,edit){vm.files[index].edit=edit,edit&&(vm.files[index].renameFileName=vm.files[index].name)}}]),
angular.module("bots").controller("GraphDialogController",["$scope","$rootScope","$timeout","$stateParams","Dialogs",function($scope,$rootScope,$timeout,$stateParams,Dialogs){function zoomed(){svg.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")}function tick(){path.attr("d",diagonal),edgelabels.attr("x",function(d){return(d.source.x+w/2+d.target.x+w/2)/2}).attr("y",function(d){return(d.source.y+h/2+d.target.y+h/2)/2}),rect.attr("transform",transform),line.attr("transform",transform),line2.attr("transform",transform),text.attr("transform",transform),text2.attr("transform",transform),text3.attr("transform",transform)}function transform(d){return"translate("+d.x+","+d.y+")"}function click(d){currentNode=d,update(),angular.element(document.getElementById("control")).scope().findOne(d.id),$(".modal-with-form").click()}function wrap(text,width,maxLine){text.each(function(){for(var word,text=d3.select(this),words=text.text().split(/\s+/).reverse(),line=[],lineHeight=1.1,dy=(text.attr("y"),parseFloat(text.attr("dy"))),tspan=text.text(null).append("tspan").attr("x",5).attr("dy",dy+"em"),linenum=1;word=words.pop();)if(line.push(word),tspan.text(line.join(" ")),tspan.node().getComputedTextLength()>width){if(++linenum>maxLine)return line.pop(),void tspan.text(line.join(" ")+"...");line.pop(),tspan.text(line.join(" ")),line=[word],tspan=text.append("tspan").attr("x",5).attr("dy",lineHeight+"em").text(word)}})}function update(){if(currentNode){var dcx=width/2-currentNode.x*zoom.scale(),dcy=height/2-(currentNode.y-h)*zoom.scale();zoom.translate([dcx,dcy]),svg.transition().duration(500).attr("transform","translate("+dcx+","+dcy+")scale("+zoom.scale()+")"),svg.append("rect").attr("id",currentNode.name).attr("x",currentNode.x).attr("y",currentNode.y).attr("width",w).attr("height",h).attr("rx",5).attr("ry",5).style("fill","black").style("opacity","0.3"),setTimeout(function(){d3.select("#"+currentNode.name).remove()},1300)}}var currentNode,nodes=[],links=[];$scope.$on("updateLog",function(event,arg0){if($rootScope.logUpdated.indexOf("[DIALOG_SEL]")!=-1){var json=$rootScope.logUpdated.substring("[DIALOG_SEL]".length);console.log(json),currentNode=null;try{var dialog=JSON.parse(json);for(var i in nodes)if(nodes[i].id==dialog.id){currentNode=nodes[i];break}currentNode&&(console.log(JSON.stringify(currentNode)),update())}catch(e){console.log(e)}}}),$scope.addInput=function(){$scope.dialog.inputs.push({str:""})},$scope.addOutput=function(){$scope.dialog.outputs.push({str:""})};var makeStr=function(obj){return Array.isArray(obj)?obj.map(function(o){return{str:o}}):[{str:obj}]},unMake=function(obj){if(Array.isArray(obj))return obj.map(function(o){return o.str})};$scope.findOne=function(dialogId){var botId=$rootScope.botId;$scope.dialog={botId:botId,dialogId:dialogId};var dialog=Dialogs.get({botId:botId,dialogId:dialogId},function(){$scope.dialog.name=dialog.name,$scope.dialog.inputs=makeStr(dialog.inputs),$scope.dialog.outputs=makeStr(dialog.outputs),$(".modal-with-form").click()})},$scope.update=function(isValid){if($scope.error=null,!isValid)return $scope.$broadcast("show-errors-check-validity","dialogForm"),!1;var dialog=$scope.dialog;dialog.inputs=unMake($scope.dialog.inputs),dialog.outputs=unMake($scope.dialog.outputs),console.log(JSON.stringify(dialog)),Dialogs.update(dialog)};var force,zoom,svg,tip,path,node,rect,text,line,text2,text3,line2,edgelabels,handleInput=function(input){return"string"==typeof input?input:input.types&&input.types[0].name?"[타입] "+input.types[0].name:input.if?"[조건] "+input.if:input},handlePrintOutput=function(output){if("string"==typeof output)return output;if(Array.isArray(output)){for(var _output="",i=0;i<output.length;i++)0!=i&&(_output+=", "),_output+=handlePrintOutput(output[i]);return _output}return output.if?"[조건] "+output.if:output},num=0,handleDialog=function(dialog){dialog.name=dialog.name||(dialog.name="dialog"+ ++num),nodes[dialog.name]=nodes[dialog.name]||(nodes[dialog.name]={name:dialog.name}),nodes[dialog.name].id=dialog.id,nodes[dialog.name].input=handleInput(dialog.input),nodes[dialog.name].output=handlePrintOutput(dialog.output),nodes[dialog.name].dialog=dialog,dialog.children&&dialog.children.forEach(function(child){handleDialog(child)})},handleOutput=function(dialog,output){output.output&&handleOutput(dialog,output.output),output.options&&output.options.returnDialog&&links.push({source:nodes[dialog.name],target:nodes[output.options.returnDialog],type:"returnDialog"}),output.call&&links.push({source:nodes[dialog.name],target:nodes[output.call],type:"call"}),output.callChild&&links.push({source:nodes[dialog.name],target:nodes[output.callChild],type:"callChild"}),output.returnCall&&links.push({source:nodes[dialog.name],target:nodes[output.returnCall],type:"returnCall"})},handleLink=function(dialog){if(dialog.children&&dialog.children.forEach(function(child){handleLink(child),links.push({source:nodes[dialog.name],target:nodes[child.name],type:"child"})}),Array.isArray(dialog.output))for(var i=0;i<dialog.output.length;++i)handleOutput(dialog,dialog.output[i]);else handleOutput(dialog,dialog.output)},width=document.getElementById("canvas").clientWidth,height=document.getElementById("sidebar-left").clientHeight,w=200,h=70;d3.json("/js/dialog.json2",function(data){console.log(data);var dialogs=data;dialogs.forEach(handleDialog),dialogs.forEach(handleLink),console.log(nodes),console.log(links),force=d3.layout.force().nodes(d3.values(nodes)).links(links).size([width,height]).linkDistance(400).charge(-2500).on("tick",tick).start(),zoom=d3.behavior.zoom().scaleExtent([.3,10]).on("zoom",zoomed),svg=d3.select("#canvas").append("svg").attr("width",width).attr("height",height).call(zoom).append("svg:g"),force.drag().on("dragstart",function(){d3.event.sourceEvent.stopPropagation()}),tip=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(d){return"<strong>Input:</strong><br/><span style='color:cornflowerblue'>"+("string"==typeof d.input?d.input.replace(/(?:\r\n|\r|\n)/g,"<br />"):d.input)+"</span><br/><br/><strong>Output:</strong><br/><span style='color:cornflowerblue'>"+("string"==typeof d.output?d.output.replace(/(?:\r\n|\r|\n)/g,"<br />"):d.output)+"</span>"}),svg.call(tip),svg.append("defs").selectAll("marker").data(["call","callChild","returnCall","returnDialog","child"]).enter().append("marker").attr("id",function(d){return d}).attr("viewBox","0 -5 10 10").attr("refX",10).attr("refY",-1.5).attr("markerWidth",6).attr("markerHeight",6).attr("orient","auto").append("path").attr("d","M0,-5L10,0L0,5"),path=svg.append("g").selectAll("path").data(force.links()).enter().append("path").attr("class",function(d){return"link "+d.type}).attr("marker-end",function(d){return"url(#"+d.type+")"}),edgelabels=svg.selectAll(".edgelabel").data(force.links()).enter().append("text").text(function(d){return d.type}),node=svg.selectAll(".node").data(force.nodes()).enter().append("g").attr("class","node").on("click",click).call(force.drag),rect=node.append("rect").attr("width",w).attr("height",h).attr("rx",5).attr("ry",5).style("fill","#DADAEB").on("mouseover",tip.show).on("mouseout",tip.hide),text=node.append("text").style("pointer-events","none").attr("x",20).attr("dy","1.35em").style("font-weight","bold").text(function(d){return d.name}),line=node.append("line").style("pointer-events","none").attr("x1",0).attr("y1","18").attr("x2",w).attr("y2","18").style("stroke",function(d){return d3.rgb("#7CA4C0").darker()}),text2=node.append("text").style("pointer-events","none").attr("x",7).attr("dy","3em").text(function(d){return"In: "+d.input}).call(wrap,w-30,1),line2=node.append("line").style("pointer-events","none").attr("x1",0).attr("y1","37").attr("x2",w).attr("y2","37").attr("stroke-width",1).attr("stroke-dasharray","0,2 1").attr("stroke","gray"),text3=node.append("text").style("pointer-events","none").attr("x",7).attr("dy","5em").text(function(d){return"Out: "+d.output}).call(wrap,w-25,2)});var diagonal=d3.svg.diagonal().source(function(d){var x1=d.source.x+w/2,y1=d.source.y+h/2,x2=d.target.x+w/2,y2=d.target.y+h/2,startx=x1,starty=y1;return Math.abs(y2-y1)<h+h/2?x1<x2?startx+=w/2:startx-=w/2:y1<y2?starty+=h/2:starty-=h/2,{x:startx,y:starty}}).target(function(d){var x1=d.source.x+w/2,y1=d.source.y+h/2,x2=d.target.x+w/2,y2=d.target.y+h/2,endx=x2,endy=y2;return Math.abs(y2-y1)<h+h/2?x1<x2?endx-=w/2:endx+=w/2:y1<y2?endy-=h/2:endy+=h/2,{x:endx,y:endy}}).projection(function(d){return[d.x,d.y]})}]),angular.module("bots").controller("GraphKnowledgeController",["$scope","$rootScope","$state","$window","$timeout","$stateParams","$resource",function($scope,$rootScope,$state,$window,$timeout,$stateParams,$resource,Authentication){function zoomed(){svg.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")}function linkArc(d){return"M"+d.source.x+","+d.source.y+"L"+d.target.x+","+d.target.y}function tick(){path.attr("d",linkArc),circle.attr("transform",transform),edgelabels.attr("x",function(d){return(d.source.x+d.target.x)/2}).attr("y",function(d){return(d.source.y+d.target.y)/2})}function transform(d){return d.isMain&&(d.x=width/2,d.y=height/2),"translate("+d.x+","+d.y+")"}function click(d){}function fillCircle(d){return d.isMain?mainColor:d.isHighlighted?highlightedColor:colors(d.name.length%5)}function radiusCircle(d){return d.isMain?3*radius:d.isHighlighted?2*radius:d.count<10?10+radius*(d.count/10):radius}function update(){path=path.data(links),path.enter().append("path").attr("class",function(d){return"link "+d.type}),path.exit().remove(),circle=circle.data(d3.values(nodes)),circle.selectAll("circle").transition().duration(700).attr("r",radiusCircle).style("fill",fillCircle);var g=circle.enter().append("svg:g");g.on("click",click).call(force.drag),g.append("circle").attr("r",radiusCircle).attr("class","node").transition().duration(700).style("fill",fillCircle),g.append("text").attr("x",0).attr("y",0).style("text-anchor","middle").style("alignment-baseline","middle").style("font-weight","bold").style("pointer-events","none").text(function(d){return d.name}),circle.exit().remove(),force.nodes(d3.values(nodes)).links(links).start()}var vm=this;vm.userId=$rootScope.userId,console.log("KnowledgeGrpah Controller");var nodes=[],links=[],addLink=function(r){void 0==nodes[r.node1]&&(nodes[r.node1]={name:r.node1,isMain:!1,isHighlighted:!1,count:0}),void 0==nodes[r.node2]&&(nodes[r.node2]={name:r.node2,isMain:!1,isHighlighted:!1,count:0}),links.push({source:nodes[r.node1],target:nodes[r.node2],type:"child",kind:r.link}),nodes[r.node1].count++,nodes[r.node2].count++,console.log(JSON.stringify({source:nodes[r.node1],target:nodes[r.node2],type:"child",kind:r.link}))},resetNodes=function(){for(var key in nodes)nodes[key].isHighlighted=!1,nodes[key].isMain=!1};$resource("/api/factLinks/find/:factUserID",{}).query({factUserID:vm.userId},function(res){for(var i=0;i<res.length;i++)addLink(res[i]);console.log(nodes),console.log(links),update()}),$scope.$on("updateLog",function(event,arg0){if($rootScope.logUpdated.indexOf("[FACT_ADD]")!=-1){var json=$rootScope.logUpdated.substring("[FACT_ADD]".length);try{addLink(JSON.parse(json))}catch(e){console.log(e)}}update()});var timer=null,timer2=null,timer3=null;$scope.$on("keyinput",function(event,arg0){null==timer&&(timer=setTimeout(function(){var input=arg0;$resource("/api/user-bots-analytics/nlp",{}).get({input:input},function(res){if(resetNodes(),void 0!=res.result){var highLightedNodes=res.result.split(" ");if(void 0!=highLightedNodes){console.log(highLightedNodes);for(var i=0;i<highLightedNodes.length;++i)void 0!=nodes[highLightedNodes[i]]&&(nodes[highLightedNodes[i]].isHighlighted=!0,console.log(JSON.stringify(nodes[highLightedNodes[i]])))}}update(),null==timer2&&(timer2=setTimeout(function(){resetNodes(),update(),timer2=null},3e3)),timer=null})},100))}),$scope.$on("onmsg",function(event,arg0){var input=arg0.message;resetNodes(),$resource("/api/user-bots-analytics/nlp",{}).get({input:input},function(res){if(res.result){var centeredNodes=res.result.split(" ");if(void 0!=centeredNodes)for(var i=0;i<centeredNodes.length;++i)if(void 0!=nodes[centeredNodes[i]]){nodes[centeredNodes[i]].isMain=!0,nodes[centeredNodes[i]].x=width/2,nodes[centeredNodes[i]].y=height/2,console.log(JSON.stringify(nodes[centeredNodes[i]]));break}}}),update(),null==timer3&&(timer3=setTimeout(function(){resetNodes(),update(),timer3=null},3e3))});var width=document.getElementById("canvas").clientWidth,height=document.getElementById("sidebar-left").clientHeight,force=d3.layout.force().nodes(d3.values(nodes)).links(links).size([width,height]).linkDistance(100).charge(-300).on("tick",tick),zoom=d3.behavior.zoom().scaleExtent([.3,10]).on("zoom",zoomed),svg=d3.select("#canvas").append("svg").attr("width",width).attr("height",height).call(zoom).append("svg:g"),path=svg.append("svg:g").selectAll("path"),circle=svg.append("svg:g").selectAll("g"),edgelabels=svg.selectAll(".edgelabel");force.drag().on("dragstart",function(){d3.event.sourceEvent.stopPropagation()});var radius=30,mainColor="lightblue",highlightedColor="pink",colors=d3.scale.category20c(d3.range(0,20));update()}]),angular.module("bots").controller("IDEController",["$scope","$timeout","$stateParams","fileResolve","BotFilesService","Socket","CoreUtils",function($scope,$timeout,$stateParams,file,BotFilesService,Socket,CoreUtils){function build(){emitMsg(":build "+vm.botName+" reset")}function viewGraph(){emitMsg(":viewGraph "+vm.botName)}function init(){emitMsg(":reset user"),setTimeout(function(){console.log("init: "+vm.initMsg),void 0!=vm.initMsg&&null!=vm.initMsg&&""!=vm.initMsg&&emitMsg(vm.initMsg)},200)}function emitMsg(msg){Socket.emit("send_msg",{host:vm.server.split(":")[0],port:vm.server.split(":")[1],bot:vm.botName,user:vm.userId,msg:msg})}var vm=this;vm.codemirrorOpts={lineWrapping:!0,lineNumbers:!0,mode:"javascript"},vm.servers=["localhost:1024"],vm.server=vm.servers[0],vm.userId="",vm.msg="",vm.connect=function(){if(!vm.userId||vm.userId.length<=0)return void alert("유저명을 입력해주세요!");Socket.socket||Socket.connect(),vm.isConnected=!0,init()},vm.isConnected=!1,vm.sendMsg=function(msg){if(console.log("sendMsg: "+msg),!vm.isConnected)return!1;var useInput=!1;return(!msg||msg.length<=0)&&(msg=vm.msg,useInput=!0),!(!msg||msg.length<=0)&&(":build"==msg?(build(),!1):":viewGraph"==msg?(viewGraph(),!1):":init"==msg?(init(),!1):(emitMsg(vm.msg),void(useInput&&(vm.msg=""))))},vm.init=init,vm.botName=file.botName,vm.name=file.name,vm.data=file.data,$scope.refreshCodemirror=!0,$timeout(function(){$scope.refreshCodemirror=!1},100),vm.viewGraph=function(){new BotFilesService({botId:$stateParams.botId,_id:$stateParams.fileId,fileData:vm.data}).$save(function(botFile){vm.sendMsg(":viewGraph")},function(err){CoreUtils.showConfirmAlert(err.data.message)})},vm.buildBot=function(){new BotFilesService({botId:$stateParams.botId,_id:$stateParams.fileId,fileData:vm.data}).$save(function(botFile){vm.sendMsg(":build")},function(err){CoreUtils.showConfirmAlert(err.data.message)})},vm.save=function(){new BotFilesService({botId:$stateParams.botId,_id:$stateParams.fileId,fileData:vm.data}).$save(function(botFile){CoreUtils.showConfirmAlert("저장되었습니다.")},function(err){CoreUtils.showConfirmAlert(err.data.message)})},Socket.on("send_msg",function(message){console.log("out:"+message)}),$scope.$on("$destroy",function(){Socket.removeListener("send_msg")}),vm.userId="com2best",vm.connect()}]),angular.module("bots").controller("BotListController",["$scope","$stateParams","botsResolve","BotsService",function($scope,$stateParams,bots,BotsService){var vm=this;vm.bots=bots,angular.forEach(vm.bots,function(bot){bot.channel="",bot.kakao&&(bot.channel+="카카오톡"),bot.line&&(bot.channel.length>0&&(bot.channel+=", "),bot.channel+="라인"),bot.facebook&&(bot.channel.length>0&&(bot.channel+=", "),bot.channel+="페이스북")})}]),angular.module("user-bots").controller("UserBotListController",["$scope","$rootScope","$stateParams","$state","userBotsResolve","UserBotsService","UserBotsFollowService","$http","Authentication",function($scope,$rootScope,$stateParams,$state,userBots,UserBotsService,UserBotsFollowService,$http,Authentication){var vm=this;vm.authentication=Authentication,vm.userBots=userBots,"mobile"==_platform&&("recent"==$stateParams.listType?vm.listTypeName="최신봇":"followed"==$stateParams.listType?vm.listTypeName="친구봇":"my"==$stateParams.listType?vm.listTypeName="마이봇":vm.listTypeName="인기봇"),vm.listType=$stateParams.listType,vm.currentPage=1,vm.perPage=10,vm.paging=function(find){find&&(vm.userBots=[],vm.currentPage=0,console.log("find")),vm.currentPageCopy=angular.copy(vm.currentPage),vm.currentPage=vm.currentPage+1;var url="";url="followed"==vm.listType?"/api/user-bots/follow":"/api/user-bots/list",$http.post(url,{currentPage:vm.currentPageCopy,perPage:vm.perPage,listType:vm.listType,botUserId:vm.authentication.user._id,query:vm.query}).success(function(response){response.length?(console.log(response),vm.userBots.push.apply(vm.userBots,response)):vm.pagingEnd=!0}).error(function(reponse){console.log(reponse)})},vm.followBot=function(userBot){UserBotsFollowService.follow({botUserId:vm.userId,userBot:userBot._id},function(err,result){})},vm.unfollowBot=function(userBot){UserBotsFollowService.unfollow({botUserId:vm.userId,userBot:userBot._id},function(err,result){})},vm.userBotChat=function(userBot){console.log("vm.userBotChat"),$rootScope.$broadcast("setUserBot",userBot)},vm.goFind=function(){vm.listType,$state.go("user-bots-web.list",{query:vm.query,listType:vm.listType})},angular.forEach(vm.userBots,function(userBot){userBot.channel="",userBot.kakao&&(userBot.channel+="카카오톡"),userBot.line&&(userBot.channel.length>0&&(userBot.channel+=", "),userBot.channel+="라인"),userBot.facebook&&(userBot.channel.length>0&&(userBot.channel+=", "),userBot.channel+="페이스북")})}]),angular.module("user-bots").controller("UserBotChatController",["$state","$rootScope","$scope","$stateParams","$document","$timeout","$window","$compile","$resource","$cookies","Socket","UserBotsService","$ionicModal",function($state,$rootScope,$scope,$stateParams,$document,$timeout,$window,$compile,$resource,$cookies,Socket,UserBotsService,$ionicModal){function build(){clearBubble(),emitMsg(":build "+vm.bot+" reset")}function init(){clearBubble(),emitMsg(":reset user")}function emitMsg(msg){Socket.emit("send_msg",{host:vm.server.split(":")[0],port:vm.server.split(":")[1],bot:vm.bot,user:vm.userId,msg:msg})}function recognizeStart(){if(recognizing)return void recognition.stop();final_transcript="",recognition.lang="ko-KR",recognition.start(),ignore_onend=!1,start_timestamp=event.timeStamp}function clearBubble(){document.getElementById("chat_main").innerText="",document.chatForm.inputbox.value=""}function addBotBubble(msg){var text=msg&&msg.text?msg.text:msg,d=new Date,datetext=d.getHours()+":"+d.getMinutes(),innerHTML='<div class="item item-avatar b-none friend"><img src="'+vm.userBot.imageFile+'"><div class="text-xs"><span class="font-bold m-r-sm">'+vm.userBot.name+'</span><span class="color-grey-500">'+datetext+'</span></div><div class="bubble"><i class="icon-tail"></i><div class="content"><div class="content-text">'+text+"</div>";if(msg.buttons)for(var i in msg.buttons)innerHTML+='<div class="bubble-button"><a href="'+msg.buttons[i].url+'" target="_blank">'+msg.buttons[i].text+"</a></div>";innerHTML+="</div></div>",innerHTML+="</div>";var main=document.getElementById("chat_main");main.insertAdjacentHTML("beforeend",innerHTML),main.scrollTop=main.scrollHeight-main.clientHeight}function addButtons(replies){if(void 0!=replies){var innerHTML="";innerHTML='<div id="smart_reply" class="smart_reply owl-carousel owl-theme" >';for(var i in replies)innerHTML+='<div class="item"><button ng-click="vm.sendMsg(\''+replies[i]+'\')" style="width: auto;" >'+replies[i]+"</button></div>";innerHTML+="</div>";var main=document.getElementById("chat_main");main.style.padding="10px 0px 30px 0px",main.insertAdjacentHTML("beforeend",innerHTML);var replies=document.getElementById("smart_reply").childNodes;for(var i in replies){var child=replies[i].firstChild;child&&child.style&&(child.style.width=child.offsetWidth+5+"px")}$(".smart_reply").owlCarousel({loop:!1,nav:!1,dots:!1,margin:3,autoWidth:!0});$compile(angular.element(document.querySelector("#smart_reply")).contents())($scope)}}function addItems(items){var innerHTML='<div class="chat-items owl-carousel owl-theme" style="clear: both">';for(var i in items){if(innerHTML+='<div class="item" ><div class="thumbnail">',items[i].imageUrl&&(innerHTML+='<img src="'+items[i].imageUrl+'" >'),innerHTML+='<div class="caption">',items[i].title&&(innerHTML+="<h3>"+items[i].title+"</h3>"),items[i].text&&(innerHTML+="<p>"+items[i].text+"</p>"),innerHTML+="</div>",items[i].buttons)for(var j in items[i].buttons)innerHTML+='<div class="chat-item-button"><a href="'+items[i].buttons[j].url+'" target="_blank">'+items[i].buttons[j].text+"</a></div>";innerHTML+="</div></div>"}innerHTML+="</div>",main.insertAdjacentHTML("beforeend",innerHTML),$(".chat-items").owlCarousel({loop:!1,nav:!1,margin:0,items:2}),main.scrollTop=main.scrollHeight-main.clientHeight}function addUserBubble(msg){var bubble,main=document.getElementById("chat_main"),d=new Date,datetext=d.getHours()+":"+d.getMinutes(),bubble=document.createElement("div");bubble.setAttribute("class","item item-avatar-right b-none me"),bubble.innerHTML='<div class="text-xs"><span class="font-bold m-r-sm"></span><span class="color-grey-500">'+datetext+'</span></div><div class="bubble"><i class="icon-tail-me"></i><span class="content">'+msg+"</span></div>",main.appendChild(bubble),document.chatForm.inputbox.value="",main.scrollTop=main.scrollHeight-main.clientHeight}function synthesize(message){var utterance=new SpeechSynthesisUtterance(message);utterance.lang="ko-KR",utterance.onstart=function(event){console.log("synthesize start")},utterance.onerror=function(event){console.log("synthesize error")},utterance.onend=function(event){console.log("synthesize end")},window.speechSynthesis.speak(utterance)}function generateUUID(){var d=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=(d+16*Math.random())%16|0;return d=Math.floor(d/16),("x"==c?r:3&r|8).toString(16)})}var vm=this;$scope.vm=vm,vm.server="localhost:1024",vm.bot=$stateParams.userBotId||$cookies.get("default_bot")||"athena",vm.userBot={},vm.userId="",vm.msg="",vm.isConnected=!1,vm.isVoice=!1;var main=document.getElementById("chat_main");vm.connect=function(){if(!vm.userId||vm.userId.length<=0)return void alert("유저명을 입력해주세요!");Socket.socket||Socket.connect(),$cookies.put("default_bot",vm.bot),vm.isConnected=!0,init()},Socket.on("send_msg",function(message){if(0==message.lastIndexOf(":log")){if(!($state.is("developer-home")||$state.is("user-bots.context-analytics")||$state.is("bots.graph-knowledge")||$state.is("bots.graph-dialog")))return;return $rootScope.logUpdated=message.substring(message.indexOf("\n")+1),void $rootScope.$broadcast("updateLog")}try{message=JSON.parse(message)}catch(e){}if(void 0!=message.bot&&vm.changeBotInfo(message.bot),message.smartReply&&addButtons(message.smartReply),message.items?addItems(message.items):addBotBubble(message),vm.isVoice){var voice=message.voice||message.text||message;if(voice+=",",message.items){for(var i in message.items){var item=message.items[i];voice+=0==i?"첫번째 , ":"다음 , ",voice+=item.title+","}voice+="여기까지 입니다."}synthesize(voice)}$rootScope.$broadcast("onmsg",{message:message})}),vm.mobileModal=function(){$ionicModal.fromTemplateUrl("my-modal.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.modal=modal,$scope.modal.show()}),$scope.closeModal=function(){$scope.modal.hide()},$scope.$on("$destroy",function(){$scope.modal.remove()}),$scope.$on("modal.hidden",function(){}),$scope.$on("modal.removed",function(){})},vm.fbShare=function(){$scope.location=location.href,FB.ui({method:"share",display:"popup",href:$scope.location,title:vm.userBot.name,description:vm.userBot.description,picture:location.protocol+"//"+location.hostname+"/"+vm.userBot.imageFile},function(response){console.log(response)})},vm.kakaoShare=function(){$scope.location=location.href,console.log(vm.userBot.description),Kakao.Story.share({url:$scope.location,text:vm.userBot.name+"-"+vm.userBot.description})},vm.kakaoTalkShare=function(){$scope.location=location.href,Kakao.Link.sendTalkLink({label:vm.userBot.name+"-"+vm.userBot.description,image:{src:location.protocol+"//"+location.hostname+"/"+vm.userBot.imageFile,width:80,height:80},webButton:{text:"플레이 챗으로 가요",url:$scope.location}})},vm.twitterShare=function(){$scope.location=location.href,window.open("https://twitter.com/intent/tweet?text="+vm.userBot.name+"-"+vm.userBot.description+"&url="+$scope.location,"popup","width=600, height=400")},vm.sendMsg=function(msg){if(!vm.isConnected)return!1;var element=document.getElementById("smart_reply");element&&(element.parentNode.removeChild(element),main.style.padding="10px 0px 0px 0px");var useInput=!1;if((!msg||msg.length<=0)&&(msg=vm.msg,useInput=!0),!msg||msg.length<=0)return!1;if(":build"==msg)return build(),!1;if(":init"==msg)return init(),!1;if(0==msg.lastIndexOf(":connect")){var args=msg.split(/\s/);return args.length>1&&vm.connectUserBot(args[1]),!1}return addUserBubble(msg),emitMsg(msg),useInput&&(vm.msg=""),!1},vm.buildBot=function(){vm.sendMsg(":build")},vm.resetBot=function(){vm.sendMsg(":init")},vm.changeBotInfo=function(userBot){vm.bot=userBot.id,$cookies.put("default_bot",vm.bot),vm.userBot=userBot,$rootScope.botId=userBot.id,$rootScope.userBot=vm.userBot;var header=document.getElementById("chat-header");header&&(header.innerText=vm.bot)},vm.connectUserBot=function(botId){clearBubble(),$resource("/api/user-bots/byNameId/:botNameId",{botNameId:"@id"}).get({botNameId:botId},function(data){vm.changeBotInfo(data),vm.connect()},function(err){vm.changeBotInfo({id:vm.bot,name:vm.bot}),vm.connect()})},$document.bind("keydown",function(event){$rootScope.$broadcast("keyinput",vm.msg),116==event.keyCode?vm.buildBot():27==event.keyCode&&vm.resetBot()}),vm.init=init,$scope.$on("$destroy",function(){Socket.removeListener("send_msg")}),vm.connectUserBot(vm.bot);var recognition,ignore_onend,start_timestamp,regcognitionTimer,final_transcript="",recognizing=!1,finalFinish=!1,timeoutFinish=!1;"webkitSpeechRecognition"in window?(recognition=new webkitSpeechRecognition,recognition.continuous=!0,recognition.interimResults=!0,recognition.onstart=function(){final_transcript="",recognizing=!0},recognition.onerror=function(event){"no-speech"==event.error&&(console.log("info_no_speech"),ignore_onend=!0),"audio-capture"==event.error&&(console.log("info_no_microphone"),ignore_onend=!0),"not-allowed"==event.error&&(event.timeStamp-start_timestamp<100?console.log("info_blocked"):console.log("info_denied"),ignore_onend=!0)},recognition.onend=function(){recognition.start(),recognizing=!1,ignore_onend||final_transcript&&console.log("on End: "+final_transcript)},recognition.onresult=function(event){console.log(event);for(var isFinal=!1,interim_transcript="",i=event.resultIndex;i<event.results.length;++i)event.results[i].isFinal&&(isFinal=!0),interim_transcript+=event.results[i][0].transcript;if(!vm.isVoice)return void recognition.stop();if(document.getElementById("inputbox").value=interim_transcript,final_transcript=interim_transcript,(final_transcript||interim_transcript)&&console.log("transcript:"+interim_transcript),isFinal){if(console.log("isFinal:"+finalFinish+","+timeoutFinish),timeoutFinish)return finalFinish=!1,void(timeoutFinish=!1);finalFinish=!0,console.log("isFinal:"+interim_transcript),vm.sendMsg(interim_transcript)}else regcognitionTimer&&clearTimeout(regcognitionTimer),regcognitionTimer=setTimeout(function(){if(console.log("timeout:"+finalFinish+","+timeoutFinish),finalFinish)return finalFinish=!1,void(timeoutFinish=!1);timeoutFinish||(timeoutFinish=!0,console.log("timeout: "+interim_transcript),void 0!=interim_transcript&&""!=interim_transcript&&(ignore_onend=!0,vm.sendMsg(final_transcript)))},2e3)}):console.log("upgrade"),vm.toggleVoice=function(){vm.isVoice?(vm.isVoice=!1,ignore_onend=!0,recognition.stop(),document.getElementById("inputbox").placeholder="대화를 입력해 주세요.",document.getElementById("voiceButton").style.fontWeight="300",document.getElementById("voiceButton").style.color="#777"):(vm.isVoice=!0,document.getElementById("inputbox").placeholder="음성으로 말씀해 주세요.",document.getElementById("voiceButton").style.fontWeight="600",document.getElementById("voiceButton").style.color="#0088cc",recognizeStart())},void 0==$cookies.get("userId")?(vm.userId=generateUUID(),$cookies.put("userId",vm.userId),$rootScope.userId=vm.userId):(vm.userId=$cookies.get("userId"),$rootScope.userId=vm.userId),"web"==_platform&&angular.element("#inputbox").focus(),"mobile"!=_platform&&(document.getElementById("chat-header").innerText=vm.bot),$scope.$on("setUserBot",function(event,arg0){var userBot=arg0;vm.bot=userBot.id,vm.userBot=userBot,vm.connectUserBot(vm.bot)}),$scope.$on("connectUserBot",function(event,arg0){vm.connectUserBot(arg0.id)});vm.isVoice&&recognizeStart()}]),angular.module("user-bots").controller("UserBotController",["$scope","$rootScope","$state","$window","$timeout","$stateParams","Authentication","userBotResolve","FileUploader","UserBotsService","UserBotCommentService","UserBotDialogService","UserBotsFollowService","$http","$uibModal",function($scope,$rootScope,$state,$window,$timeout,$stateParams,Authentication,userBot,FileUploader,UserBotsService,UserBotCommentService,UserBotDialogService,UserBotsFollowService,$http,$uibModal){var vm=this;vm.user=Authentication.user,vm.userBot=userBot,vm.userBot.public=!0,vm.userId=$rootScope.userId,vm.isMine=null!=vm.userBot.user&&vm.user.username===vm.userBot.user.username,vm.isLearnable=vm.userBot.learn||vm.isMine,vm.userBot.userFollow=UserBotsFollowService.list({userBot:vm.userBot,botUserId:vm.user._id},function(res){res.length>0?vm.userBot.userFollow=!0:vm.userBot.userFollow=void 0}),console.log(vm.user),vm.type="",$state.is("user-bots-web.create")?(vm.state="create",vm.type="edit"):$state.is("user-bots-web.edit")?(vm.state="edit",vm.type="edit"):$state.is("user-bots-web.view")&&(vm.state="view",vm.type="view"),vm.changeType=function(type){vm.type=type},vm.followBot=function(userBot){UserBotsFollowService.follow({botUserId:vm.user._id,userBot:userBot._id},function(err,result){vm.userBot.userFollow=!0})},vm.unfollowBot=function(userBot){UserBotsFollowService.unfollow({botUserId:vm.user._id,userBot:userBot._id},function(err,result){vm.userBot.userFollow=void 0})},vm.userBotChat=function(userBot){console.log("vm.userBotChat"),$rootScope.$broadcast("setUserBot",userBot)},vm.fbShare=function(){$scope.location=location.href,FB.ui({method:"share",display:"popup",href:$scope.location,title:vm.userBot.name,description:vm.userBot.description,picture:location.protocol+"//"+location.hostname+"/"+vm.userBot.imageFile},function(response){console.log(response)})},vm.kakaoShare=function(){$scope.location=location.href,console.log(vm.userBot.description),Kakao.Story.share({url:$scope.location,text:vm.userBot.name+"-"+vm.userBot.description})},vm.twitterShare=function(){$scope.location=location.href,window.open("https://twitter.com/intent/tweet?text="+vm.userBot.name+"-"+vm.userBot.description+"&url="+$scope.location,"popup","width=600, height=400")},vm.create=function(isValid){if($scope.error=null,$scope.submitted=!0,!isValid)return $scope.$broadcast("show-errors-check-validity","userBotForm"),!1;vm.learning=!0,vm.userBot.imageFile||(vm.userBot.imageFile="/files/default.png"),vm.type="connect",vm.userBot.$save(function(response){vm.learning=!1,$scope.close=function(){modalInstance.dismiss()};var modalInstance=$uibModal.open({templateUrl:"modules/bots/client/views/modal-user-bots.client.learning.html",scope:$scope});modalInstance.result.then(function(response){console.log(response)}),
($state.is("user-bots-web.create")||$state.is("user-bots-web.edit"))&&$rootScope.$broadcast("setUserBot",vm.userBot)},function(errorResponse){$scope.error=errorResponse.data.message})},vm.remove=function(){var modalInstance=$uibModal.open({templateUrl:"modules/bots/client/views/modal-user-bots.client.remove.html",scope:$scope});$scope.delete=function(){vm.userBot&&vm.userBot._id&&vm.userBot.$remove(function(){$state.go("user-bots-web.list",{listType:"my"})},function(errorResponse){$scope.error=errorResponse.data.message})},$scope.close=function(){modalInstance.dismiss()}},vm.update=function(isValid){if(console.log(isValid),$scope.error=null,$scope.submitted=!0,!isValid)return $scope.$broadcast("show-errors-check-validity","userBotForm"),!1;console.log(vm.userBot._id),vm.userBot&&vm.userBot._id&&vm.userBot.$update(function(){$state.go("user-bots-web.list",{listType:"my"})},function(errorResponse){console.log(errorResponse),$scope.error=errorResponse.data.message})},vm.modal=function(channel,method){$scope.channel=channel,$scope.method=method,$scope.userBotId=vm.userBot.id,"facebook"==channel&&"easy"!==method&&FB.api("/me/accounts?fields=picture,name,link,access_token",function(response){if(console.log(response),2500==response.error.code){var url="/api/auth/facebook/page";$state.previous&&$state.previous.href&&(url+="?redirect_to="+encodeURIComponent($state.previous.href)),console.log(url),$window.location.href=url}$scope.pageList=[],$scope.pageList=response.data}),$scope.close=function(){modalInstance.dismiss()},$scope.connect=function(page){modalInstance.dismiss(),console.log(page),FB.api("me/subscribed_apps?access_token="+page,"post",function(response){console.log(response)})};var modalInstance=$uibModal.open({templateUrl:"modules/bots/client/views/modal-user-bots.client.connect.html",scope:$scope});modalInstance.result.then(function(response){console.log(response)})},vm.dialog=new UserBotDialogService({user:vm.user,userBot:vm.userBot,botId:vm.userBot.id}),vm.dialogs=UserBotDialogService.query({botId:vm.userBot.id}),vm.createDialog=function(){vm.dialog.$save(function(response){vm.dialogs.push(response),vm.dialog=new UserBotDialogService({user:vm.user,userBot:vm.userBot,botId:vm.userBot.id})},function(errorResponse){$scope.error=errorResponse.data.message,vm.dialog=new UserBotDialogService({user:vm.user,userBot:vm.userBot,botId:vm.userBot.id})})},vm.updateDialog=function(dialog){dialog.userBotId=vm.userBot.id,dialog.$update(function(response){console.log(response)})},vm.removeDialog=function(dialog){dialog.userBotId=vm.userBot.id,dialog.$remove(function(response){console.log(response),dialog.deleted="true"})},vm.comment=new UserBotCommentService({user:vm.user,userBot:vm.userBot,userBotId:vm.userBot._id}),vm.comments=UserBotCommentService.query({userBotId:vm.userBot._id}),vm.createComment=function(){vm.comment.$save(function(response){vm.comments.push(response),console.log(vm.comments),vm.comment=new UserBotCommentService({user:vm.user,userBot:vm.userBot,userBotId:vm.userBot._id})},function(errorResponse){$scope.error=errorResponse.data.message,vm.comment=new UserBotCommentService({user:vm.user,userBot:vm.userBot,userBotId:vm.userBot._id})})},vm.updateComment=function(comment){comment.userBotId=vm.userBot._id,comment.$update(function(response){console.log(response)})},vm.removeComment=function(comment){comment.userBotId=vm.userBot._id,comment.$remove(function(response){console.log(response),comment.deleted="true"})},$scope.imageURL=void 0,$scope.error={},$scope.success={},$scope.imageUploader=new FileUploader({url:"/api/user-bots/image-files",alias:"uploadImageFile",autoUpload:!0}),$scope.imageUploader.filters.push({name:"imageFilter",fn:function(item,options){var type="|"+item.type.slice(item.type.lastIndexOf("/")+1)+"|";return"|jpg|png|jpeg|bmp|gif|".indexOf(type)==-1?($scope.success.image=null,$scope.error.image="이미지 파일이 아니에요"):$scope.error.image=null,"|jpg|png|jpeg|bmp|gif|".indexOf(type)!==-1}}),$scope.imageUploader.onAfterAddingFile=function(fileItem){if($window.FileReader){var fileReader=new FileReader;fileReader.readAsDataURL(fileItem._file),fileReader.onload=function(fileReaderEvent){$timeout(function(){$scope.imageURL=fileReaderEvent.target.result},0)}}},$scope.imageUploader.onSuccessItem=function(fileItem,response,status,headers){$scope.success.image=!0,vm.userBot.imageFile="/files/"+response.filename,$scope.cancelImageUpload()},$scope.imageUploader.onErrorItem=function(fileItem,response,status,headers){$scope.cancelImageUpload(),$scope.error=response.message},$scope.uploadImageFiles=function(){$scope.success=$scope.error=null,$scope.imageUploader.uploadAll()},$scope.cancelImageUpload=function(){$scope.imageUploader.clearQueue()},$scope.uploader=new FileUploader({url:"/api/dialogsets/uploadfile",alias:"uploadFile",autoUpload:!0}),$scope.uploader.filters.push({name:"fileFilter",fn:function(item,options){var type="|"+item.type.slice(item.type.lastIndexOf("/")+1)+"|";return"|plain|txt|csv|".indexOf(type)==-1?($scope.success.file=null,$scope.error.file="대화 파일이 아니에요"):$scope.error.file=null,"|plain|txt|csv|smi|".indexOf(type)!==-1}}),$scope.uploader.onAfterAddingFile=function(fileItem){if($window.FileReader){var fileReader=new FileReader;fileReader.readAsDataURL(fileItem._file),fileReader.onload=function(fileReaderEvent){$timeout(function(){},0)}}},$scope.uploader.onSuccessItem=function(fileItem,response,status,headers){$scope.success.file=!0,vm.userBot.path=response.path,vm.userBot.filename=response.filename,vm.userBot.originalFilename=response.originalFilename,vm.userBot.fileuploaded=!0,$scope.cancelUpload()},$scope.uploader.onErrorItem=function(fileItem,response,status,headers){$scope.cancelUpload(),$scope.error=response.message},$scope.uploadDialogFiles=function(){$scope.success=$scope.error=null,$scope.uploader.uploadAll()},$scope.cancelUpload=function(){$scope.uploader.clearQueue()}}]),function(){function CampaignsController($scope,$state,Authentication,campaign,botUsers,campaignUsers,FileUploader,CampaignUsersService){function remove(){confirm("Are you sure you want to delete?")&&vm.campaign.$remove($state.go("campaigns.list"),{},{reload:!0})}function save(isValid){function successCallback(res){console.log("success"),createCampaignUser(vm.campaignUsers,0,function(){$state.go("campaigns.list",{campaignId:res._id},{reload:!0})})}function errorCallback(res){vm.error=res.data.message}if(!isValid)return $scope.$broadcast("show-errors-check-validity","vm.form.campaignForm"),!1;vm.campaign._id?vm.campaign.$update(successCallback,errorCallback):vm.campaign.$save(successCallback,errorCallback)}function createCampaignUser(botUsers,index,callback){if(console.log("create: "+index),!botUsers||index<0||index>=botUsers.length)return void callback();var campaignUser=new CampaignUsersService({campaignId:vm.campaign._id});campaignUser.botUser=botUsers[index]._id,campaignUser.campaign=vm.campaign._id,campaignUser.$save(function(res){createCampaignUser(botUsers,index+1,callback)},function(res){createCampaignUser(botUsers,index+1,callback)})}var vm=this;vm.categories=["설문","이벤트"],vm.botUsers=botUsers,vm.campaignUsers=[],campaignUsers&&angular.forEach(campaignUsers,function(campaignUser){vm.campaignUsers.push(campaignUser.botUser)}),vm.authentication=Authentication,vm.campaign=campaign,vm.error=null,vm.form={},vm.remove=remove,vm.save=save,vm.uploader=new FileUploader,vm.uploader.onAfterAddingFile=function(fileItem){vm.image=fileItem.file.name},vm.campaign.category||(vm.campaign.category=vm.categories[0])}angular.module("campaigns").controller("CampaignsController",CampaignsController),CampaignsController.$inject=["$scope","$state","Authentication","campaignResolve","botUsersResolve","campaignUsersResolve","FileUploader","CampaignUsersService"]}(),function(){function CampaignsListController(campaigns){this.campaigns=campaigns}angular.module("campaigns").controller("CampaignsListController",CampaignsListController),CampaignsListController.$inject=["campaignsResolve"]}(),function(){function CampaignUsersController(campaign,campaignUsers){var vm=this;vm.campaign=campaign,vm.campaignUsers=campaignUsers}angular.module("campaigns").controller("CampaignUsersController",CampaignUsersController),CampaignUsersController.$inject=["campaignResolve","campaignUsersResolve"]}(),function(){function CanonicalsController($scope,$state,Authentication,canonical){function remove(){confirm("Are you sure you want to delete?")&&vm.canonical.$remove($state.go("canonicals.list"),{},{reload:!0})}function save(isValid){function successCallback(res){$state.go("canonicals.list",{canonicalId:res._id},{reload:!0})}function errorCallback(res){vm.error=res.data.message}if(!isValid)return $scope.$broadcast("show-errors-check-validity","vm.form.canonicalForm"),!1;vm.canonical._id?vm.canonical.$update(successCallback,errorCallback):vm.canonical.$save(successCallback,errorCallback)}var vm=this;vm.authentication=Authentication,vm.canonical=canonical,vm.error=null,vm.form={},vm.remove=remove,vm.save=save}angular.module("canonicals").controller("CanonicalsController",CanonicalsController),CanonicalsController.$inject=["$scope","$state","Authentication","canonicalResolve"]}(),function(){function CanonicalsListController(canonicals){this.canonicals=canonicals}angular.module("canonicals").controller("CanonicalsListController",CanonicalsListController),CanonicalsListController.$inject=["canonicalsResolve"]}(),angular.module("chat").controller("ChatController",["$scope","$location","Authentication","Socket",function($scope,$location,Authentication,Socket){$scope.messages=[],Authentication.user||$location.path("/"),Socket.socket||Socket.connect(),Socket.on("chatMessage",function(message){$scope.messages.unshift(message)}),$scope.sendMessage=function(){var message={text:this.messageText};Socket.emit("chatMessage",message),this.messageText=""},$scope.$on("$destroy",function(){Socket.removeListener("chatMessage")})}]),function(){function CommonActionsController($scope,$state,Authentication,commonAction){function remove(){confirm("Are you sure you want to delete?")&&vm.commonAction.$remove($state.go("common-actions.list"))}function save(isValid){function successCallback(res){$state.go("common-actions.list",{commonActionId:res._id})}function errorCallback(res){vm.error=res.data.message}if(!isValid)return $scope.$broadcast("show-errors-check-validity","vm.form.commonActionForm"),!1;vm.commonAction._id?vm.commonAction.$update(successCallback,errorCallback):vm.commonAction.$save(successCallback,errorCallback)}var vm=this;vm.codemirrorOpts={lineWrapping:!0,lineNumbers:!0,mode:"javascript"},vm.actionTypes=["REST","DB"],vm.restMethods=["GET","POST","PUT","DELETE"],vm.dbMethods=["find","findOne","findById"],vm.authentication=Authentication,vm.commonAction=commonAction,vm.error=null,vm.form={},vm.remove=remove,vm.save=save,vm.commonAction.type||(vm.commonAction.type=vm.actionTypes[0])}angular.module("common-actions").controller("CommonActionsController",CommonActionsController),CommonActionsController.$inject=["$scope","$state","Authentication","commonActionResolve"]}(),function(){function CommonActionsListController(commonActions){this.commonActions=commonActions}angular.module("common-actions").controller("CommonActionsListController",CommonActionsListController),CommonActionsListController.$inject=["commonActionsResolve"]}(),function(){function ConceptsController($scope,$state,Authentication,concept){function remove(){confirm("Are you sure you want to delete?")&&vm.concept.$remove($state.go("concepts.list"),{},{reload:!0})}function save(isValid){function successCallback(res){$state.go("concepts.list",{conceptId:res._id},{reload:!0})}function errorCallback(res){vm.error=res.data.message}if(!isValid)return $scope.$broadcast("show-errors-check-validity","vm.form.conceptForm"),!1;vm.concept._id?vm.concept.$update(successCallback,errorCallback):vm.concept.$save(successCallback,errorCallback)}var vm=this;vm.authentication=Authentication,vm.concept=concept,vm.error=null,vm.form={},vm.remove=remove,vm.save=save}angular.module("concepts").controller("ConceptsController",ConceptsController),ConceptsController.$inject=["$scope","$state","Authentication","conceptResolve"]}(),function(){function ConceptsListController(concepts){this.concepts=concepts}angular.module("concepts").controller("ConceptsListController",ConceptsListController),ConceptsListController.$inject=["conceptsResolve"]}(),angular.module("core").controller("HeaderController",["$scope","$state","Authentication","Menus",function($scope,$state,Authentication,Menus){$scope.$state=$state,$scope.authentication=Authentication,$scope.menu=Menus.getMenu("topbar"),$scope.isCollapsed=!1,$scope.toggleCollapsibleMenu=function(){$scope.isCollapsed=!$scope.isCollapsed},$scope.$on("$stateChangeSuccess",function(){$scope.isCollapsed=!1})}]),angular.module("core").controller("HomeController",["$scope","$rootScope","$document","$cookies","Authentication","Socket",function($scope,$rootScope,$document,$cookies,Authentication,Socket){function logScrollBottom(){var logDiv=document.getElementById("logDiv");logDiv.scrollTop=logDiv.scrollHeight-logDiv.clientHeight}var vm=this;$scope.authentication=Authentication,vm.connectBot=function(){console.log("connectBot"),$rootScope.$broadcast("connectUserBot",{id:vm.bot})},vm.log="",$scope.$on("updateLog",function(event,arg0){vm.log+=$rootScope.logUpdated,logScrollBottom()})}]),angular.module("core").controller("PrivateBotController",["$scope","$document","Authentication","Socket",function($scope,$document,Authentication,Socket){function build(){clearBubble(),emitMsg(":build "+vm.bot+" reset")}function init(){clearBubble(),emitMsg(":reset user")}function emitMsg(msg){Socket.emit("send_msg",{host:vm.server.split(":")[0],port:vm.server.split(":")[1],bot:vm.bot,user:vm.userId,msg:msg})}var vm=this;vm.servers=["localhost:1024"],vm.bots=["order"],vm.server=vm.servers[0],vm.bot=vm.bots[0],vm.userId="",vm.msg="",vm.isConnected=!1,vm.connect=function(){if(!vm.userId||vm.userId.length<=0)return void alert("유저명을 입력해주세요!");Socket.socket||Socket.connect(),vm.isConnected=!0,init()},vm.init=init,vm.sendMsg=function(msg){if(console.log("sendMsg: "+msg),!vm.isConnected)return!1;var useInput=!1;return(!msg||msg.length<=0)&&(msg=vm.msg,useInput=!0),!(!msg||msg.length<=0)&&(":build"==msg?(build(),!1):":init"==msg?(init(),!1):(addUserBubble(msg),emitMsg(msg),void(useInput&&(vm.msg=""))))},vm.buildBot=function(){vm.sendMsg(":build")},vm.resetBot=function(){vm.sendMsg(":init")},$document.bind("keydown",function(event){116==event.keyCode?vm.buildBot():27==event.keyCode&&vm.resetBot()}),Socket.on("send_msg",function(message){if(console.log("out:"+message),!message.startsWith(":log")){var url,idx=message.indexOf("url: ");idx!=-1&&(url=message.substring(idx+5,message.length),message=message.substring(0,idx),console.log("url:"+url),document.getElementById("webframe").src=url),addBotBubble(message)}}),$scope.$on("$destroy",function(){Socket.removeListener("send_msg")});var recognition,ignore_onend,start_timestamp,regcognitionTimer,final_transcript="",recognizing=!1,finalFinish=!1,timeoutFinish=!1;"webkitSpeechRecognition"in window?(recognition=new webkitSpeechRecognition,recognition.continuous=!0,recognition.interimResults=!0,recognition.onstart=function(){console.log("recognition.onstart"),final_transcript="",recognizing=!0},recognition.onerror=function(event){console.log("recognition.onerror"),"no-speech"==event.error&&(console.log("info_no_speech"),ignore_onend=!0),"audio-capture"==event.error&&(console.log("info_no_microphone"),ignore_onend=!0),"not-allowed"==event.error&&(event.timeStamp-start_timestamp<100?console.log("info_blocked"):console.log("info_denied"),ignore_onend=!0)},recognition.onend=function(){if(console.log("recognition.onend"),recognition.start(),recognizing=!1,!ignore_onend)return final_transcript?void console.log("on End: "+final_transcript):void console.log("info_start")},recognition.onresult=function(event){console.log(event);for(var isFinal=!1,interim_transcript="",i=event.resultIndex;i<event.results.length;++i)event.results[i].isFinal&&(isFinal=!0),interim_transcript+=event.results[i][0].transcript;if(final_transcript=interim_transcript,(final_transcript||interim_transcript)&&console.log("transcript:"+interim_transcript),isFinal){if(console.log("isFinal:"+finalFinish+","+timeoutFinish),timeoutFinish)return finalFinish=!1,void(timeoutFinish=!1);finalFinish=!0,console.log("isFinal:"+interim_transcript),vm.sendMsg(interim_transcript)}else regcognitionTimer&&clearTimeout(regcognitionTimer),regcognitionTimer=setTimeout(function(){if(console.log("timeout:"+finalFinish+","+timeoutFinish),finalFinish)return finalFinish=!1,void(timeoutFinish=!1);timeoutFinish||(timeoutFinish=!0,console.log("timeout: "+interim_transcript),void 0!=interim_transcript&&""!=interim_transcript&&(ignore_onend=!0,vm.sendMsg(final_transcript)))},2e3)}):console.log("upgrade"),vm.bot="private_bot",vm.userId="com2best",vm.connect()}]),angular.module("core").controller("AlertController",["$scope","$stateParams","$uibModalInstance","resolve",function($scope,$stateParams,$uibModalInstance,resolve){resolve.message&&($scope.message=resolve.message),resolve.yesText?$scope.yesText=resolve.yesText:$scope.yesText="확인",resolve.noText?$scope.noText=resolve.noText:$scope.noText=void 0,$scope.yes=function(){$uibModalInstance.close(),resolve.callback&&resolve.callback()},$scope.no=function(){$uibModalInstance.close()}}]),angular.module("core").controller("SideMenuController",["$rootScope","$scope","$state","$window","Authentication","$ionicModal","$ionicSideMenuDelegate","$ionicHistory","$ionicLoading","$ionicScrollDelegate","$ionicNavBarDelegate",function($rootScope,$scope,$state,$window,Authentication,$ionicModal,$ionicSideMenuDelegate,$ionicHistory,$ionicLoading,$ionicScrollDelegate,$ionicNavBarDelegate){$scope.$state=$state,$scope.authentication=Authentication,console.log("side-menu 0 "),$scope.onMenu=function(state,params){console.log("onMenu from : "+$ionicHistory.currentStateName()+" to : "+state);$ionicHistory.backView(),$ionicHistory.backTitle(),$ionicHistory.viewHistory();$state.go(state,params),$ionicSideMenuDelegate.toggleLeft(!1)},$scope.logout=function(){$window.location.href="/api/auth/signout"},$rootScope.lockScreen=function(show,callback){show?callback?$ionicLoading.show({noBackdrop:!0,duration:1e4}).then(callback):$ionicLoading.show({noBackdrop:!0,duration:1e4}):callback?$ionicLoading.hide().then(callback):$ionicLoading.hide()},$rootScope.getIonicScrollDelegate=function(handleName){return $ionicScrollDelegate.$getByHandle(handleName)},$rootScope.changeNavBarTitle=function(title){$ionicNavBarDelegate.title(title)},$rootScope.signinModal=void 0,$ionicModal.fromTemplateUrl("modules/users/client/views/authentication/signin.mobile.view.html",{}).then(function(modal){$rootScope.signinModal=modal}),$rootScope.showSigninModal=function(){$rootScope.signinModal&&$rootScope.signinModal.show()},$rootScope.closeSigninModal=function(){$rootScope.signinModal&&$rootScope.signinModal.hide().then(function(){}),$ionicSideMenuDelegate.toggleLeft(!1)},$rootScope.mobileHome=function(then){$ionicHistory.clearHistory(),$ionicHistory.nextViewOptions({disableBack:!0,historyRoot:!0}),then?$state.go("mobile.messengers.list",{},{location:"replace"}).then(then):$state.go("mobile.messengers.list",{},{location:"replace"})},$rootScope.mobileBack=function(){$ionicHistory.goBack()},$rootScope.mobileState=function(state,params,removeBack,disableBack){$state.go(state,params).then(function(){removeBack&&$ionicHistory.removeBackView()})}}]),angular.module("core").controller("SideMenu2Controller",["$rootScope","$scope","$state","$window","Authentication","$ionicModal","$ionicSideMenuDelegate","$ionicHistory","$ionicLoading","$ionicScrollDelegate","$ionicNavBarDelegate",function($rootScope,$scope,$state,$window,Authentication,$ionicModal,$ionicSideMenuDelegate,$ionicHistory,$ionicLoading,$ionicScrollDelegate,$ionicNavBarDelegate){$scope.$state=$state,$scope.authentication=Authentication,$scope.onMenu=function(state,params){$state.go(state,params),$ionicSideMenuDelegate.toggleLeft(!1)},$rootScope.getIonicScrollDelegate=function(handleName){return $ionicScrollDelegate.$getByHandle(handleName)},$rootScope.changeNavBarTitle=function(title){$ionicNavBarDelegate.title(title)},$rootScope.mobileHome=function(then){$ionicHistory.clearHistory(),$ionicHistory.nextViewOptions({disableBack:!0,historyRoot:!0}),then?$state.go("mobile.messengers.list",{},{location:"replace"}).then(then):$state.go("mobile.messengers.list",{},{location:"replace"})},$rootScope.mobileBack=function(){$ionicHistory.goBack()},$rootScope.mobileState=function(state,params,removeBack,disableBack){$state.go(state,params).then(function(){removeBack&&$ionicHistory.removeBackView()})},$scope.list=function(filter){}}]),angular.module("core").controller("UserBotHeaderController",["$scope","$state","Authentication","$location","$rootScope",function($scope,$state,Authentication,$location,$rootScope){$scope.$state=$state,$scope.authentication=Authentication,$scope.currentUrl=$location.absUrl()}]),angular.module("core").controller("UserHomeController",["$scope","$document","Authentication","Socket",function($scope,$document,Authentication,Socket){function build(){clearBubble(),emitMsg(":build "+vm.bot+" reset")}function init(){clearBubble(),emitMsg(":reset user")}function emitMsg(msg){Socket.emit("send_msg",{host:vm.server.split(":")[0],port:vm.server.split(":")[1],bot:vm.bot,user:vm.userId,msg:msg})}function recognizeStart(){if(recognizing)return void recognition.stop();final_transcript="",recognition.lang="ko-KR",recognition.start(),ignore_onend=!1,console.log("info_allow"),start_timestamp=event.timeStamp}var vm=this;vm.servers=["localhost:1024"],vm.bots=["order"],vm.server=vm.servers[0],vm.bot=vm.bots[0],vm.userId="",vm.msg="",vm.isConnected=!1,vm.connect=function(){if(!vm.userId||vm.userId.length<=0)return void alert("유저명을 입력해주세요!");Socket.socket||Socket.connect(),vm.isConnected=!0,init()},vm.init=init,vm.sendMsg=function(msg){if(console.log("sendMsg: "+msg),!vm.isConnected)return!1;var useInput=!1;return(!msg||msg.length<=0)&&(msg=vm.msg,useInput=!0),!(!msg||msg.length<=0)&&(":build"==msg?(build(),!1):":init"==msg?(init(),!1):(addUserBubble(msg),emitMsg(msg),void(useInput&&(vm.msg=""))))},vm.buildBot=function(){vm.sendMsg(":build")},vm.resetBot=function(){vm.sendMsg(":init")},$document.bind("keydown",function(event){116==event.keyCode?vm.buildBot():27==event.keyCode&&vm.resetBot()}),Socket.on("send_msg",function(message){if(console.log("out:"+message),message.lastIndexOf(":log")){var url,idx=message.indexOf("url: ");idx!=-1&&(url=message.substring(idx+5,message.length),message=message.substring(0,idx),console.log("url:"+url),document.getElementById("webframe").src=url),addBotBubble(message),synthesize(message);new Audio("/images/doorbell-6.mp3").play()}}),$scope.$on("$destroy",function(){Socket.removeListener("send_msg")});var recognition,ignore_onend,start_timestamp,regcognitionTimer,final_transcript="",recognizing=!1,finalFinish=!1,timeoutFinish=!1;"webkitSpeechRecognition"in window?(recognition=new webkitSpeechRecognition,recognition.continuous=!0,recognition.interimResults=!0,recognition.onstart=function(){console.log("recognition.onstart"),final_transcript="",recognizing=!0},recognition.onerror=function(event){console.log("recognition.onerror"),"no-speech"==event.error&&(console.log("info_no_speech"),ignore_onend=!0),"audio-capture"==event.error&&(console.log("info_no_microphone"),ignore_onend=!0),"not-allowed"==event.error&&(event.timeStamp-start_timestamp<100?console.log("info_blocked"):console.log("info_denied"),ignore_onend=!0)},recognition.onend=function(){if(console.log("recognition.onend"),recognition.start(),recognizing=!1,!ignore_onend)return final_transcript?void console.log("on End: "+final_transcript):void console.log("info_start")},recognition.onresult=function(event){console.log(event);for(var isFinal=!1,interim_transcript="",i=event.resultIndex;i<event.results.length;++i)event.results[i].isFinal&&(isFinal=!0),interim_transcript+=event.results[i][0].transcript;if(final_transcript=interim_transcript,(final_transcript||interim_transcript)&&console.log("transcript:"+interim_transcript),isFinal){if(console.log("isFinal:"+finalFinish+","+timeoutFinish),timeoutFinish)return finalFinish=!1,void(timeoutFinish=!1);finalFinish=!0,console.log("isFinal:"+interim_transcript),vm.sendMsg(interim_transcript)}else regcognitionTimer&&clearTimeout(regcognitionTimer),regcognitionTimer=setTimeout(function(){if(console.log("timeout:"+finalFinish+","+timeoutFinish),finalFinish)return finalFinish=!1,void(timeoutFinish=!1);timeoutFinish||(timeoutFinish=!0,console.log("timeout: "+interim_transcript),void 0!=interim_transcript&&""!=interim_transcript&&(ignore_onend=!0,vm.sendMsg(final_transcript)))},2e3)}):console.log("upgrade"),vm.bot="lgdemo",vm.userId="com2best",vm.connect(),recognizeStart(),recognition.stop()}]),angular.module("core").controller("WebcsController",["$scope","$document","Authentication","Socket",function($scope,$document,Authentication,Socket){function build(){clearBubble(),emitMsg(":build "+vm.bot+" reset")}function init(){clearBubble(),emitMsg(":reset user")}function emitMsg(msg){Socket.emit("send_msg",{host:vm.server.split(":")[0],port:vm.server.split(":")[1],bot:vm.bot,user:vm.userId,msg:msg})}function recognizeStart(){if(recognizing)return void recognition.stop();final_transcript="",recognition.lang="ko-KR",recognition.start(),ignore_onend=!1,console.log("info_allow"),start_timestamp=event.timeStamp}var vm=this;$scope.authentication=Authentication,vm.servers=["localhost:1024"],vm.bots=["order"],vm.server=vm.servers[0],vm.bot=vm.bots[0],vm.userId="",vm.msg="",vm.isConnected=!1,vm.connect=function(){if(!vm.userId||vm.userId.length<=0)return void alert("유저명을 입력해주세요!");Socket.socket||Socket.connect(),vm.isConnected=!0,init()},vm.init=init,vm.sendMsg=function(msg){if(console.log("sendMsg: "+msg),!vm.isConnected)return!1;var useInput=!1;return(!msg||msg.length<=0)&&(msg=vm.msg,useInput=!0),!(!msg||msg.length<=0)&&(":build"==msg?(build(),!1):":init"==msg?(init(),!1):(addUserBubble(msg),emitMsg(msg),void(useInput&&(vm.msg=""))))},vm.buildBot=function(){vm.sendMsg(":build")},vm.resetBot=function(){vm.sendMsg(":init")},$document.bind("keydown",function(event){116==event.keyCode?vm.buildBot():27==event.keyCode&&vm.resetBot()}),Socket.on("send_msg",function(message){console.log("out:"+message);var url,idx=message.indexOf("url: ");idx!=-1&&(url=message.substring(idx+5,message.length),message=message.substring(0,idx),console.log("url:"+url),document.getElementById("webframe").src=url),addBotBubble(message),synthesize(message),new Audio("/images/doorbell-6.mp3").play()}),$scope.$on("$destroy",function(){Socket.removeListener("send_msg")});var recognition,ignore_onend,start_timestamp,regcognitionTimer,final_transcript="",recognizing=!1,finalFinish=!1,timeoutFinish=!1;"webkitSpeechRecognition"in window?(recognition=new webkitSpeechRecognition,recognition.continuous=!0,recognition.interimResults=!0,recognition.onstart=function(){console.log("recognition.onstart"),final_transcript="",recognizing=!0},recognition.onerror=function(event){console.log("recognition.onerror"),"no-speech"==event.error&&(console.log("info_no_speech"),ignore_onend=!0),"audio-capture"==event.error&&(console.log("info_no_microphone"),ignore_onend=!0),"not-allowed"==event.error&&(event.timeStamp-start_timestamp<100?console.log("info_blocked"):console.log("info_denied"),ignore_onend=!0)},recognition.onend=function(){if(console.log("recognition.onend"),recognition.start(),recognizing=!1,!ignore_onend)return final_transcript?void console.log("on End: "+final_transcript):void console.log("info_start")},recognition.onresult=function(event){console.log(event);for(var isFinal=!1,interim_transcript="",i=event.resultIndex;i<event.results.length;++i)event.results[i].isFinal&&(isFinal=!0),interim_transcript+=event.results[i][0].transcript;if(final_transcript=interim_transcript,(final_transcript||interim_transcript)&&console.log("transcript:"+interim_transcript),isFinal){if(console.log("isFinal:"+finalFinish+","+timeoutFinish),timeoutFinish)return finalFinish=!1,void(timeoutFinish=!1);finalFinish=!0,console.log("isFinal:"+interim_transcript),vm.sendMsg(interim_transcript)}else regcognitionTimer&&clearTimeout(regcognitionTimer),regcognitionTimer=setTimeout(function(){if(console.log("timeout:"+finalFinish+","+timeoutFinish),finalFinish)return finalFinish=!1,void(timeoutFinish=!1);timeoutFinish||(timeoutFinish=!0,console.log("timeout: "+interim_transcript),void 0!=interim_transcript&&""!=interim_transcript&&(ignore_onend=!0,vm.sendMsg(final_transcript)))},2e3)}):console.log("upgrade"),vm.bot="demo2",vm.userId="com2best",vm.connect(),recognizeStart(),recognition.stop()}]),function(){function CustomActionsController($scope,$state,Authentication,customAction){function remove(){confirm("Are you sure you want to delete?")&&vm.customAction.$remove($state.go("custom-actions.list"))}function save(isValid){function successCallback(res){$state.go("custom-actions.list",{customActionId:res._id})}function errorCallback(res){vm.error=res.data.message}if(!isValid)return $scope.$broadcast("show-errors-check-validity","vm.form.customActionForm"),!1;vm.customAction._id?vm.customAction.$update(successCallback,errorCallback):vm.customAction.$save(successCallback,errorCallback)}var vm=this;vm.codemirrorOpts={lineWrapping:!0,lineNumbers:!0,mode:"javascript"},vm.authentication=Authentication,vm.customAction=customAction,vm.error=null,vm.form={},vm.remove=remove,vm.save=save,vm.customAction.code||(vm.customAction.code="function execute(name, params, callback) {\n  console.log('execute: ' + name);\n  // Execute Actions ..\n  callback(true);\n}\n\n\n\n\n\n")}angular.module("custom-actions").controller("CustomActionsController",CustomActionsController),CustomActionsController.$inject=["$scope","$state","Authentication","customActionResolve"]}(),function(){function CustomActionsListController(customActions){this.customActions=customActions}angular.module("custom-actions").controller("CustomActionsListController",CustomActionsListController),CustomActionsListController.$inject=["customActionsResolve"]}(),function(){function DeliveryOrderMenusController($scope,$state,Authentication,menus){function save(isValid){function successCallback(res){$state.go("deliveryOrders.list",{deliveryOrderId:res.deliveryOrder},{reload:!0})}function errorCallback(res){vm.error=res.data.message}if(!isValid)return $scope.$broadcast("show-errors-check-validity","vm.form.deliveryOrderForm"),!1;vm.menus.$update(successCallback,errorCallback)}function onKeyPress(event){40==event.keyCode&&vm.addMenu()}var vm=this;vm.authentication=Authentication,vm.error=null,vm.form={},vm.save=save,vm.onKeyPress=onKeyPress,vm.menus=menus,vm.addMenu=function(){vm.menus._menus.push({name:"",price:"",options:[{optionName:"",optionValues:[{name:"",price:""}]}],additions:[{name:"",price:""}]})},vm.removeMenu=function(index){vm.menus._menus.splice(index,1)},vm.addOptions=function(index){vm.menus._menus[index].options.push({optionName:"",optionValues:[{name:"",price:""}]})},vm.removeOptions=function(index,index2){vm.menus._menus[index].options.splice(index2,1)},vm.addOptionMenu=function(index,index2){vm.menus._menus[index].options[index2].optionValues.push({name:"",price:""})},vm.removeOptionMenu=function(index,index2,index3){vm.menus._menus[index].options[index2].optionValues.splice(index3,1)},vm.addAdditionMenu=function(index){vm.menus._menus[index].additions.push({name:"",price:""})},vm.removeAdditionMenu=function(index,index2){vm.menus._menus[index].additions.splice(index2,1)},void 0!=vm.menus._menus&&0!=vm.menus._menus.length||(vm.menus._menus=[],vm.addMenu())}
angular.module("deliveryOrders").controller("DeliveryOrderMenusController",DeliveryOrderMenusController),DeliveryOrderMenusController.$inject=["$scope","$state","Authentication","menuResolve"]}(),function(){function DeliveryOrdersController($scope,$state,Authentication,deliveryOrder){function remove(){confirm("Are you sure you want to delete?")&&vm.deliveryOrder.$remove($state.go("deliveryOrders.list"),{},{reload:!0})}function save(isValid){function successCallback(res){$state.go("deliveryOrders.list",{},{reload:!0})}function errorCallback(res){vm.error=res.data.message}if(!isValid)return $scope.$broadcast("show-errors-check-validity","vm.form.deliveryOrderForm"),!1;vm.deliveryOrder._id?vm.deliveryOrder.$update(successCallback,errorCallback):vm.deliveryOrder.$save(successCallback,errorCallback)}var vm=this;vm.authentication=Authentication,vm.deliveryOrder=deliveryOrder,vm.error=null,vm.form={},vm.remove=remove,vm.save=save}angular.module("deliveryOrders").controller("DeliveryOrdersController",DeliveryOrdersController),DeliveryOrdersController.$inject=["$scope","$state","Authentication","deliveryOrderResolve"]}(),function(){function DeliveryOrdersListController($scope,deliveryOrders,DTOptionsBuilder,DTColumnDefBuilder){var vm=this;vm.dtOptions=DTOptionsBuilder.newOptions().withOption("order",[0,"desc"]),vm.deliveryOrders=deliveryOrders,vm.updateStatus=function(deliveryOrder,status,memo){deliveryOrder.status=status,deliveryOrder.$update(function(res){},function(res){vm.error=res.data.message})}}angular.module("deliveryOrders").controller("DeliveryOrdersListController",DeliveryOrdersListController),DeliveryOrdersListController.$inject=["$scope","deliveryOrdersResolve","DTOptionsBuilder","DTColumnDefBuilder"]}(),function(){function DialogsetDialogsController($scope,$state,$window,Authentication,dialogset,dialogsetDialogs,DialogsetDialogsService){var vm=this;vm.authentication=Authentication,vm.dialogset=dialogset,vm.dialogsetDialogs=dialogsetDialogs,vm.error=null,vm.dialog=new DialogsetDialogsService({user:vm.user,dialogset:vm.dialogset._id}),vm.createDialog=function(){vm.dialog.$save(function(response){vm.dialogsetDialogs.push(response),vm.dialog=new DialogsetDialogsService({user:vm.user,dialogset:vm.dialogset._id})},function(errorResponse){$scope.error=errorResponse.data.message,vm.dialog=new DialogsetDialogsService({user:vm.user,dialogset:vm.dialogset._id})})},vm.updateDialog=function(dialog){dialog.$update(function(response){console.log(response)})},vm.removeDialog=function(dialog){dialog.$remove(function(response){console.log(response),dialog.deleted="true"})}}angular.module("dialogsets").controller("DialogsetDialogsController",DialogsetDialogsController),DialogsetDialogsController.$inject=["$scope","$state","$window","Authentication","dialogsetResolve","dialogsetDialogResolve","DialogsetDialogsService"]}(),function(){function DialogsetsController($scope,$state,$window,Authentication,dialogset,FileUploader){function remove(){confirm("Are you sure you want to delete?")&&vm.dialogset.$remove($state.go("dialogsets.list"),{},{reload:!0})}function save(isValid){function successCallback(res){$state.go("dialogsets.list",{dialogsetId:res._id},{reload:!0})}function errorCallback(res){vm.error=res.data.message}if(!isValid)return $scope.$broadcast("show-errors-check-validity","vm.form.dialogsetForm"),!1;vm.dialogset._id?vm.dialogset.$update(successCallback,errorCallback):vm.dialogset.$save(successCallback,errorCallback)}var vm=this;vm.authentication=Authentication,vm.dialogset=dialogset,vm.error=null,vm.form={},vm.remove=remove,vm.save=save,$scope.uploader=new FileUploader({url:"/api/dialogsets/uploadfile",alias:"uploadFile",autoUpload:!0}),$scope.uploader.filters.push({name:"fileFilter",fn:function(item,options){var type="|"+item.type.slice(item.type.lastIndexOf("/")+1)+"|";return"|txt|csv|".indexOf(type)!==-1}}),$scope.uploader.onAfterAddingFile=function(fileItem){if($window.FileReader){var fileReader=new FileReader;fileReader.readAsDataURL(fileItem._file),fileReader.onload=function(fileReaderEvent){$timeout(function(){$scope.imageURL=fileReaderEvent.target.result},0)}}},$scope.uploader.onSuccessItem=function(fileItem,response,status,headers){$scope.success=!0,vm.dialogset.path=response.path,vm.dialogset.filename=response.filename,vm.dialogset.originalFilename=response.originalFilename,vm.dialogset.fileuploaded=!0,$scope.cancelUpload()},$scope.uploader.onErrorItem=function(fileItem,response,status,headers){$scope.cancelUpload(),$scope.error=response.message},$scope.uploadDialogFiles=function(){$scope.success=$scope.error=null,$scope.uploader.uploadAll()},$scope.cancelUpload=function(){$scope.uploader.clearQueue()}}angular.module("dialogsets").controller("DialogsetsController",DialogsetsController),DialogsetsController.$inject=["$scope","$state","$window","Authentication","dialogsetResolve","FileUploader"]}(),function(){function DialogsetsListController(dialogsets){this.dialogsets=dialogsets}angular.module("dialogsets").controller("DialogsetsListController",DialogsetsListController),DialogsetsListController.$inject=["dialogsetsResolve"]}(),function(){function DictsController($scope,$state,Authentication,dict){function remove(){confirm("Are you sure you want to delete?")&&vm.dict.$remove($state.go("dicts.list"),{},{reload:!0})}function save(isValid){function successCallback(res){$state.go("dicts.list",{dictId:res._id},{reload:!0})}function errorCallback(res){vm.error=res.data.message}if(!isValid)return $scope.$broadcast("show-errors-check-validity","vm.form.dictForm"),!1;vm.dict._id?vm.dict.$update(successCallback,errorCallback):vm.dict.$save(successCallback,errorCallback)}var vm=this;vm.wordClasses=["명사","대명사","수사","동사","형용사","관형사","부사","조사","감탄사"],vm.authentication=Authentication,vm.dict=dict,vm.error=null,vm.form={},vm.remove=remove,vm.save=save,vm.dict.class||(vm.dict.class=vm.wordClasses[0])}angular.module("dicts").controller("DictsController",DictsController),DictsController.$inject=["$scope","$state","Authentication","dictResolve"]}(),function(){function DictsListController(dicts){this.dicts=dicts}angular.module("dicts").controller("DictsListController",DictsListController),DictsListController.$inject=["dictsResolve"]}(),function(){function FactsController($scope,$state,Authentication,fact){function remove(){confirm("Are you sure you want to delete?")&&vm.fact.$remove($state.go("facts.list"),{},{reload:!0})}function save(isValid){function successCallback(res){$state.go("facts.list",{factId:res._id},{reload:!0})}function errorCallback(res){vm.error=res.data.message}if(!isValid)return $scope.$broadcast("show-errors-check-validity","vm.form.factForm"),!1;vm.fact._id?vm.fact.$update(successCallback,errorCallback):vm.fact.$save(successCallback,errorCallback)}var vm=this;vm.authentication=Authentication,vm.fact=fact,vm.error=null,vm.form={},vm.remove=remove,vm.save=save}angular.module("facts").controller("FactsController",FactsController),FactsController.$inject=["$scope","$state","Authentication","factResolve"]}(),function(){function FactsListController(facts){this.facts=facts}angular.module("facts").controller("FactsListController",FactsListController),FactsListController.$inject=["factsResolve"]}(),function(){function FaqsController($scope,$state,Authentication,faq){function remove(){confirm("Are you sure you want to delete?")&&vm.faq.$remove($state.go("faqs.list"))}function save(isValid,nextId){function successCallback(res){console.log(nextId),nextId?$state.go("faqs.edit",{faqId:nextId}):$state.go("faqs.create",{},{reload:!0})}function errorCallback(res){vm.error=res.data.message}if(!isValid)return $scope.$broadcast("show-errors-check-validity","vm.form.faqForm"),!1;vm.faq._id?vm.faq.$update(successCallback,errorCallback):vm.faq.$save(successCallback,errorCallback)}var vm=this;vm.authentication=Authentication,vm.faq=faq,vm.error=null,vm.form={},vm.remove=remove,vm.save=save,vm.faq.bankCode="11",vm.faq.category="올원뱅크",vm.faq.title="[올원뱅크]"}angular.module("faqs").controller("FaqsController",FaqsController),FaqsController.$inject=["$scope","$state","Authentication","faqResolve"]}(),function(){function FaqsListController(FaqsService){this.faqs=FaqsService.query()}angular.module("faqs").controller("FaqsListController",FaqsListController),FaqsListController.$inject=["FaqsService"]}(),function(){function FranchiseMenusController($scope,$state,Authentication,menus){function save(isValid){function successCallback(res){$state.go("franchises.list",{franchiseId:res.franchise},{reload:!0})}function errorCallback(res){vm.error=res.data.message}if(!isValid)return $scope.$broadcast("show-errors-check-validity","vm.form.franchiseForm"),!1;vm.menus.$update(successCallback,errorCallback)}function onKeyPress(event){40==event.keyCode&&vm.addMenu()}var vm=this;vm.authentication=Authentication,vm.error=null,vm.form={},vm.save=save,vm.onKeyPress=onKeyPress,vm.menus=menus,vm.addMenu=function(){vm.menus._menus.push({name:"",price:"",options:[{optionName:"",optionValues:[{name:"",price:""}]}],additions:[{name:"",price:""}]})},vm.removeMenu=function(index){vm.menus._menus[index]._remove=!0},vm.addOptions=function(index){vm.menus._menus[index].options.push({optionName:"",optionValues:[{name:"",price:""}]})},vm.removeOptions=function(index,index2){vm.menus._menus[index].options.splice(index2,1)},vm.addOptionMenu=function(index,index2){vm.menus._menus[index].options[index2].optionValues.push({name:"",price:""})},vm.removeOptionMenu=function(index,index2,index3){vm.menus._menus[index].options[index2].optionValues.splice(index3,1)},vm.addAdditionMenu=function(index){vm.menus._menus[index].additions.push({name:"",price:""})},vm.removeAdditionMenu=function(index,index2){vm.menus._menus[index].additions.splice(index2,1)},void 0!=vm.menus._menus&&0!=vm.menus._menus.length||(vm.menus._menus=[],vm.addMenu())}angular.module("franchises").controller("FranchiseMenusController",FranchiseMenusController),FranchiseMenusController.$inject=["$scope","$state","Authentication","menuResolve"]}(),function(){function FranchisesController($scope,$state,Authentication,franchise){function remove(){confirm("Are you sure you want to delete?")&&vm.franchise.$remove($state.go("franchises.list"),{},{reload:!0})}function save(isValid){function successCallback(res){$state.go("franchises.list",{},{reload:!0})}function errorCallback(res){vm.error=res.data.message}if(!isValid)return $scope.$broadcast("show-errors-check-validity","vm.form.franchiseForm"),!1;vm.franchise._id?vm.franchise.$update(successCallback,errorCallback):vm.franchise.$save(successCallback,errorCallback)}var vm=this;vm.authentication=Authentication,vm.franchise=franchise,vm.error=null,vm.form={},vm.remove=remove,vm.save=save}angular.module("franchises").controller("FranchisesController",FranchisesController),FranchisesController.$inject=["$scope","$state","Authentication","franchiseResolve"]}(),function(){function FranchisesListController(franchises){this.franchises=franchises}angular.module("franchises").controller("FranchisesListController",FranchisesListController),FranchisesListController.$inject=["franchisesResolve"]}(),angular.module("learnings").controller("LearningsController",["$scope","$stateParams","$location","Authentication","Learnings",function($scope,$stateParams,$location,Authentication,Learnings){$scope.authentication=Authentication,$scope.learnInput=function(){var myRe=new RegExp("d(b+)d","g");myRe.exec("cdbbdbsbz")},$scope.create=function(isValid){if($scope.error=null,!isValid)return $scope.$broadcast("show-errors-check-validity","learningForm"),!1;new Learnings({title:this.title,content:this.content}).$save(function(response){$location.path("learnings/"+response._id),$scope.title="",$scope.content=""},function(errorResponse){$scope.error=errorResponse.data.message})},$scope.remove=function(learning){if(learning){learning.$remove();for(var i in $scope.learnings)$scope.learnings[i]===learning&&$scope.learnings.splice(i,1)}else $scope.learning.$remove(function(){$location.path("learnings")})},$scope.update=function(isValid){if($scope.error=null,!isValid)return $scope.$broadcast("show-errors-check-validity","learningForm"),!1;var learning=$scope.learning;learning.$update(function(){$location.path("learnings/"+learning._id)},function(errorResponse){$scope.error=errorResponse.data.message})},$scope.find=function(){$scope.learnings=Learnings.query()},$scope.findOne=function(){$scope.learning=Learnings.get({learningId:$stateParams.learningId})}}]),function(){function MessagesListController(messages){this.messages=messages}angular.module("messages").controller("MessagesListController",MessagesListController),MessagesListController.$inject=["messagesResolve"]}(),function(){function MessagesController($scope,$state,Authentication,message){function remove(){confirm("Are you sure you want to delete?")&&vm.message.$remove($state.go("messages.list"),{},{reload:!0})}function save(isValid){function successCallback(res){$state.go("messages.list",{messageId:res._id},{reload:!0})}function errorCallback(res){vm.error=res.data.message}if(!isValid)return $scope.$broadcast("show-errors-check-validity","vm.form.messageForm"),!1;vm.message._id?vm.message.$update(successCallback,errorCallback):vm.message.$save(successCallback,errorCallback)}var vm=this;vm.authentication=Authentication,vm.message=message,vm.error=null,vm.form={},vm.remove=remove,vm.save=save}angular.module("messages").controller("MessagesController",MessagesController),MessagesController.$inject=["$scope","$state","Authentication","messageResolve"]}(),function(){function MessageSendController($state,$stateParams,FileUploader,botUsers){var vm=this;vm.users=[],$stateParams.userKey&&vm.users.push({userKey:$stateParams.userKey,channel:$stateParams.channel}),vm.text=$stateParams.text,vm.image=$stateParams.image,vm.linkMessage=$stateParams.linkMessage,vm.linkAddress=$stateParams.linkAddress,vm.botUsers=botUsers,vm.uploader=new FileUploader,vm.uploader.onAfterAddingFile=function(fileItem){vm.image=fileItem.file.name},vm.send=function(){console.log("send: "+vm.text)}}angular.module("messages").controller("MessageSendController",MessageSendController),MessageSendController.$inject=["$state","$stateParams","FileUploader","botUsersResolve"]}(),angular.module("messengers").controller("ChatMessengersController",["$scope","$document","Authentication","Socket",function($scope,$document,Authentication,Socket){function build(){clearBubble(),emitMsg(":build "+vm.bot+" reset")}function init(){clearBubble(),emitMsg(":reset user")}function emitMsg(msg){Socket.emit("send_msg",{host:vm.server.split(":")[0],port:vm.server.split(":")[1],bot:vm.bot,user:vm.userId,msg:msg})}function clearBubble(){document.getElementById("chat_main").innerText="",document.chatForm.inputbox.value=""}function addBotBubble(msg){var main=document.getElementById("chat_main"),bubble=document.createElement("div");bubble.setAttribute("class","item item-avatar b-none friend"),bubble.innerHTML='<img src="/images/venkman.jpg"><div class="text-xs"><span class="font-bold m-r-sm">'+vm.bot+'</span><span class="color-grey-500">1:35PM</span></div><div class="bubble"><i class="icon-tail"></i><span class="content">'+msg+"</span></div>",main.appendChild(bubble),main.scrollTop=main.scrollHeight-main.clientHeight}function addUserBubble(msg){var main=document.getElementById("chat_main"),bubble=document.createElement("div");bubble.setAttribute("class","item item-avatar-right b-none me"),bubble.innerHTML='<div class="text-xs"><span class="font-bold m-r-sm"></span><span class="color-grey-500">1:35PM</span></div><div class="bubble"><i class="icon-tail-me"></i><span class="content">'+msg+"</span></div>",main.appendChild(bubble),document.chatForm.inputbox.value="",main.scrollTop=main.scrollHeight-main.clientHeight}var vm=this;vm.servers=["localhost:1024"],vm.bots=["order"],vm.server=vm.servers[0],vm.bot=vm.bots[0],vm.userId="",vm.msg="",vm.isConnected=!1,vm.connect=function(){if(!vm.userId||vm.userId.length<=0)return void alert("유저명을 입력해주세요!");Socket.socket||Socket.connect(),vm.isConnected=!0,init()},vm.init=init,vm.sendMsg=function(msg){if(console.log("sendMsg: "+msg),!vm.isConnected)return!1;var useInput=!1;return(!msg||msg.length<=0)&&(msg=vm.msg,useInput=!0),!(!msg||msg.length<=0)&&(":build"==msg?(build(),!1):":init"==msg?(init(),!1):(addUserBubble(msg),emitMsg(msg),void(useInput&&(vm.msg=""))))},vm.buildBot=function(){vm.sendMsg(":build")},vm.resetBot=function(){vm.sendMsg(":init")},$document.bind("keydown",function(event){116==event.keyCode?vm.buildBot():27==event.keyCode&&vm.resetBot()}),Socket.on("send_msg",function(message){if(console.log("out:"+message),!message.startsWith(":log")){var url,idx=message.indexOf("url: ");idx!=-1&&(url=message.substring(idx+5,message.length),message=message.substring(0,idx),console.log("url:"+url),document.getElementById("webframe").src=url),addBotBubble(message)}}),$scope.$on("$destroy",function(){Socket.removeListener("send_msg")});var recognition,ignore_onend,start_timestamp,regcognitionTimer,final_transcript="",recognizing=!1,finalFinish=!1,timeoutFinish=!1;"webkitSpeechRecognition"in window?(recognition=new webkitSpeechRecognition,recognition.continuous=!0,recognition.interimResults=!0,recognition.onstart=function(){console.log("recognition.onstart"),final_transcript="",recognizing=!0},recognition.onerror=function(event){console.log("recognition.onerror"),"no-speech"==event.error&&(console.log("info_no_speech"),ignore_onend=!0),"audio-capture"==event.error&&(console.log("info_no_microphone"),ignore_onend=!0),"not-allowed"==event.error&&(event.timeStamp-start_timestamp<100?console.log("info_blocked"):console.log("info_denied"),ignore_onend=!0)},recognition.onend=function(){if(console.log("recognition.onend"),recognition.start(),recognizing=!1,!ignore_onend)return final_transcript?void console.log("on End: "+final_transcript):void console.log("info_start")},recognition.onresult=function(event){console.log(event);for(var isFinal=!1,interim_transcript="",i=event.resultIndex;i<event.results.length;++i)event.results[i].isFinal&&(isFinal=!0),interim_transcript+=event.results[i][0].transcript;if(final_transcript=interim_transcript,(final_transcript||interim_transcript)&&console.log("transcript:"+interim_transcript),isFinal){if(console.log("isFinal:"+finalFinish+","+timeoutFinish),timeoutFinish)return finalFinish=!1,void(timeoutFinish=!1);finalFinish=!0,console.log("isFinal:"+interim_transcript),vm.sendMsg(interim_transcript)}else regcognitionTimer&&clearTimeout(regcognitionTimer),regcognitionTimer=setTimeout(function(){if(console.log("timeout:"+finalFinish+","+timeoutFinish),finalFinish)return finalFinish=!1,void(timeoutFinish=!1);timeoutFinish||(timeoutFinish=!0,console.log("timeout: "+interim_transcript),void 0!=interim_transcript&&""!=interim_transcript&&(ignore_onend=!0,vm.sendMsg(final_transcript)))},2e3)}):console.log("upgrade"),vm.bot="lgdemo",vm.userId="com2best",vm.connect()}]),angular.module("messengers").controller("MessengersController",["$scope","$stateParams","$location","Authentication","Messengers",function($scope,$stateParams,$location,Authentication,Messengers){$scope.authentication=Authentication,$scope.create=function(isValid){if($scope.error=null,!isValid)return $scope.$broadcast("show-errors-check-validity","messengerForm"),!1;new Messengers({title:this.title,content:this.content}).$save(function(response){$location.path("messengers/"+response._id),$scope.title="",$scope.content=""},function(errorResponse){$scope.error=errorResponse.data.message})},$scope.remove=function(messenger){if(messenger){messenger.$remove();for(var i in $scope.messengers)$scope.messengers[i]===messenger&&$scope.messengers.splice(i,1)}else $scope.messenger.$remove(function(){$location.path("messengers")})},$scope.update=function(isValid){if($scope.error=null,!isValid)return $scope.$broadcast("show-errors-check-validity","messengerForm"),!1;var messenger=$scope.messenger;messenger.$update(function(){$location.path("messengers/"+messenger._id)},function(errorResponse){$scope.error=errorResponse.data.message})},$scope.find=function(){$scope.messengers=Messengers.query()},$scope.findOne=function(){$scope.messenger=Messengers.get({messengerId:$stateParams.messengerId})}}]),function(){function ProductsListController(ProductsService){this.products=ProductsService.query()}angular.module("products").controller("ProductsListController",ProductsListController),ProductsListController.$inject=["ProductsService"]}(),function(){function ProductsController($scope,$state,Authentication,product){function remove(){confirm("Are you sure you want to delete?")&&vm.product.$remove($state.go("products.list"))}function save(isValid){function successCallback(res){$state.go("products.create",{},{reload:!0})}function errorCallback(res){vm.error=res.data.message}if(!isValid)return $scope.$broadcast("show-errors-check-validity","vm.form.productForm"),!1;vm.product._id?vm.product.$update(successCallback,errorCallback):vm.product.$save(successCallback,errorCallback)}var vm=this;vm.authentication=Authentication,vm.product=product,vm.error=null,vm.form={},vm.remove=remove,vm.save=save,vm.product.bankCode="88"}angular.module("products").controller("ProductsController",ProductsController),ProductsController.$inject=["$scope","$state","Authentication","productResolve"]}(),function(){function RestaurantsListController(restaurants){this.restaurants=restaurants}angular.module("restaurants").controller("RestaurantsListController",RestaurantsListController),RestaurantsListController.$inject=["restaurantsResolve"]}(),function(){function MenusController($scope,$state,Authentication,menus){function save(isValid){function successCallback(res){$state.go("menu.list",{restaurantId:res._id},{reload:!0})}function errorCallback(res){vm.error=res.data.message}if(!isValid)return $scope.$broadcast("show-errors-check-validity","vm.form.restaurantForm"),!1;vm.menus.$update(successCallback,errorCallback)}function onKeyPress(event){40==event.keyCode&&vm.menus._menus.push({name:"",price:"",options:{"":{"":""}},additions:{"":""}})}var vm=this;vm.authentication=Authentication,vm.error=null,vm.form={},vm.save=save,vm.onKeyPress=onKeyPress,vm.menus=menus,void 0!=vm.menus._menus&&0!=vm.menus._menus.length||(vm.menus._menus={name:"",price:"",options:{"":{"":""}},additions:{"":""}})}angular.module("restaurants").controller("MenusController",MenusController),MenusController.$inject=["$scope","$state","Authentication","menuResolve"]}(),function(){function RestaurantsController($scope,$state,Authentication,restaurant){function remove(){confirm("Are you sure you want to delete?")&&vm.restaurant.$remove($state.go("restaurants.list"),{},{reload:!0})}function save(isValid){function successCallback(res){$state.go("restaurants.list",{restaurantId:res._id},{reload:!0})}function errorCallback(res){vm.error=res.data.message}if(!isValid)return $scope.$broadcast("show-errors-check-validity","vm.form.restaurantForm"),!1;vm.restaurant._id?vm.restaurant.$update(successCallback,errorCallback):vm.restaurant.$save(successCallback,errorCallback)}var vm=this;vm.authentication=Authentication,vm.restaurant=restaurant,vm.error=null,vm.form={},vm.remove=remove,vm.save=save}angular.module("restaurants").controller("RestaurantsController",RestaurantsController),RestaurantsController.$inject=["$scope","$state","Authentication","restaurantResolve"]}(),function(){function UserDialogsListController(userDialogs){this.userDialogs=userDialogs}angular.module("user-dialogs").controller("UserDialogsListController",UserDialogsListController),UserDialogsListController.$inject=["userDialogsResolve"]}(),function(){function UserDialogsController($scope,$state,Authentication,UserDialogsService,userDialog){function remove(){confirm("Are you sure you want to delete?")&&vm.userDialog.$remove($state.go("user-dialogs.list"))}function save(isValid){function successCallback(res){vm.error="생성되었습니다 : "+vm.userDialog.name,vm.userDialog=new UserDialogsService}function errorCallback(res){vm.error=res.data.message}if(!isValid)return $scope.$broadcast("show-errors-check-validity","vm.form.userDialogForm"),!1;vm.userDialog._id?vm.userDialog.$update(successCallback,errorCallback):vm.userDialog.$save(successCallback,errorCallback)}var vm=this;vm.channels=["카카오톡","라인","페이스북"],vm.authentication=Authentication,vm.userDialog=userDialog,vm.error=null,vm.form={},vm.remove=remove,vm.save=save,vm.userDialog.channel||(vm.userDialog.channel=vm.channels[0]),vm.randomCreate=function(){vm.userDialog.userKey=randomString(10),vm.userDialog.channel=vm.channels[Math.floor(Math.random()*vm.channels.length)],vm.userDialog.name=randomString(Math.floor(4*Math.random())+4),vm.userDialog.phone="010-"+randomNumber(4)+"-"+randomNumber(4),vm.userDialog.email=vm.userDialog.name+randomEmail(),vm.userDialog.isOn=0==Math.floor(2*Math.random())};var randomString=function(length){for(var text="",possible="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=0;i<length;i++)text+=possible.charAt(Math.floor(Math.random()*possible.length));return text},randomNumber=function(length){for(var text="",possible="0123456789",i=0;i<length;i++)text+=possible.charAt(Math.floor(Math.random()*possible.length));return text},randomEmail=function(){var emails=["@gmail.com","@moneybrain.com","@finger.co.kr","@naver.com"];return emails[Math.floor(Math.random()*emails.length)]}}angular.module("user-dialogs").controller("UserDialogsController",UserDialogsController),UserDialogsController.$inject=["$scope","$state","Authentication","UserDialogsService","userDialogResolve"]}(),angular.module("users").controller("AuthenticationController",["$scope","$state","$http","$location","$window","Authentication","PasswordValidator","$uibModal",function($scope,$state,$http,$location,$window,Authentication,PasswordValidator,$uibModal){$scope.authentication=Authentication,$scope.popoverMsg=PasswordValidator.getPopoverMsg(),$scope.error=$location.search().err;var stingParser=$state.current.name;stingParser.split(".");$scope.passwordForgot="password.forgot",$scope.authenticationSignup="authentication.signup",$scope.authenticationSignin="authentication.signin",$scope.authentication.user&&$state.go("home"),$scope.signup=function(isValid){if($scope.authentication.user&&$state.go("home"),$scope.error={},$scope.submitted=!0,!isValid)return $scope.$broadcast("show-errors-check-validity","userForm"),!1;$http.post("/api/auth/signup",$scope.credentials).success(function(response){console.log(response);var modalInstance=$uibModal.open({templateUrl:"modules/users/client/views/authentication/email.confirm.modal.html",scope:$scope});$scope.close=function(){modalInstance.dismiss(),$state.go("home")},modalInstance.result.then(function(response){console.log(response)})}).error(function(response){console.log(response),response.message.match("E-mail")?$scope.error.email="이미 존재하는 E-mail이네요":response.message.match("username")&&($scope.error.username="usernamœe already exist")})};var stingParser=$state.current.name;stingParser.split(".");$scope.privacy=function(){var modalInstance=$uibModal.open({templateUrl:"modules/users/client/views/authentication/signup.client.privacy.view.html",scope:$scope});modalInstance.result.then(function(response){console.log(response)}),$scope.close=function(){modalInstance.dismiss()}},$scope.signin=function(isValid){if($scope.error=null,$scope.submitted=!0,!isValid)return $scope.$broadcast("show-errors-check-validity","userForm"),!1;$http.post("/api/auth/signin",$scope.credentials).success(function(response){$scope.authentication.user=response,$state.go($state.previous.state.name||"home",$state.previous.params)}).error(function(response){$scope.error=response.message})},$scope.callOauthProvider=function(url){$state.previous&&$state.previous.href&&(url+="?redirect_to="+encodeURIComponent($state.previous.href)),$window.location.href=url}}]),angular.module("users").controller("PasswordController",["$scope","$stateParams","$http","$location","Authentication","PasswordValidator","$state",function($scope,$stateParams,$http,$location,Authentication,PasswordValidator,$state){$scope.authentication=Authentication,$scope.popoverMsg=PasswordValidator.getPopoverMsg(),"user-bots-web"==$state.current.name.split(".")[0]?($scope.transition="home",$scope.passwordForgot="user-bots-web.password.forgot"):$scope.passwordForgot="password.forgot",$scope.authentication.user&&$state.go("home"),$scope.askForPasswordReset=function(isValid){if($scope.success=$scope.error=null,$scope.submitted=!0,console.log($scope.forgotPasswordForm),!isValid)return $scope.$broadcast("show-errors-check-validity","forgotPasswordForm"),!1;var stingParser=$state.current.name,parsedString=stingParser.split(".");$scope.credentials.from=parsedString[0],$http.post("/api/auth/forgot",$scope.credentials).success(function(response){$scope.credentials=null,$scope.success=response.message}).error(function(response){$scope.credentials=null,$scope.error=response.message})},$scope.resetUserPassword=function(isValid){if($scope.success=$scope.error=null,$scope.submitted=!0,!isValid)return $scope.$broadcast("show-errors-check-validity","resetPasswordForm"),!1;$http.post("/api/auth/reset/"+$stateParams.token,$scope.passwordDetails).success(function(response){$scope.passwordDetails=null,Authentication.user=response,"user-bots-web"==$state.current.name.split(".")[0]?$state.go("user-bots-web.password.reset.success"):$state.go("password.reset.success")}).error(function(response){console.log(response),$scope.error=response.message})}}]),angular.module("analytics").factory("AnalyticsService",["$resource",function($resource){return $resource("api/user-count/:kind/:arg",{kind:"kind",arg:"arg"},{})}]),angular.module("analytics").factory("DialogUsageService",["$resource",function($resource){return $resource("api/dialog-usage/:kind/:arg",{kind:"kind",arg:"arg"},{})}]),angular.module("analytics").factory("SessionSuccessService",["$resource",function($resource){return $resource("api/session-success/:kind/:arg",{kind:"kind",arg:"arg"},{})}]),angular.module("analytics").factory("DialogSuccessService",["$resource",function($resource){return $resource("api/dialog-success/:kind/:arg",{kind:"kind",arg:"arg"},{})}]),angular.module("analytics").factory("DialogFailureService",["$resource",function($resource){return $resource("api/dialog-failure/:kind/:arg",{kind:"kind",arg:"arg"},{})}]),angular.module("analytics").factory("Dialogs",["$resource",function($resource){return $resource("api/dialog/:botId/:dialogId",{botId:"@botId",dialogId:"@dialogId"},{update:{method:"PUT"}})}]),angular.module("analytics").factory("DialogChildren",["$resource",function($resource){return $resource("api/dialogchildren/:botId/:dialogId",{botId:"@botId",dialogId:"@dialogId"},{})}]),angular.module("articles").factory("Articles",["$resource",function($resource){return $resource("api/articles/:articleId",{articleId:"@_id"},{update:{method:"PUT"}})}]),function(){function BanksService($resource){return $resource("api/banks/:userKey",{userKey:"@userKey"},{update:{method:"PUT"}})}angular.module("banks").factory("BanksService",BanksService),BanksService.$inject=["$resource"]}(),function(){function BotUsersService($resource){return $resource("api/bot-users/:botUserId",{botUserId:"@_id"},{update:{method:"PUT"}})}angular.module("bot-users").factory("BotUsersService",BotUsersService),BotUsersService.$inject=["$resource"]}(),angular.module("bots").factory("BotsService",["$resource",function($resource){return $resource("api/bots/:botId",{botId:"@_id"},{update:{method:"PUT"}})}]).factory("BotFilesService",["$resource",function($resource){return $resource("api/bots/files/:botId/:fileId",{botId:"@botId",fileId:"@_id"},{update:{method:"PUT"}})}]),angular.module("bots").factory("Dialogs",["$resource",function($resource){return $resource("api/dialog/:botId/:dialogId",{botId:"@botId",dialogId:"@dialogId"},{update:{method:"PUT"}})}]),
angular.module("user-bots").factory("UserBotsService",["$resource",function($resource){return $resource("api/user-bots/:userBotId",{userBotId:"@_id"},{update:{method:"PUT"}})}]).factory("UserBotsFollowService",["$resource",function($resource){return $resource("api/user-bots/follow",null,{list:{method:"POST",isArray:!0},follow:{method:"PUT"},unfollow:{method:"DELETE"}})}]).factory("UserBotFilesService",["$resource",function($resource){return $resource("api/user-bots/files/:userBotId/:fileId",{userBotId:"@userBotId",fileId:"@_id"},{update:{method:"PUT"}})}]).factory("UserBotCommentService",["$resource",function($resource){return $resource("api/user-bots-comment/:userBotId/:commentId",{userBotId:"@userBotId",commentId:"@_id"},{update:{method:"PUT"}})}]).factory("UserBotDialogService",["$resource",function($resource){return $resource("api/user-bots-dialog/:botId/:dialogId",{botId:"@botId",dialogId:"@_id"},{update:{method:"PUT"}})}]),function(){function CampaignsService($resource){return $resource("api/campaigns/:campaignId",{campaignId:"@_id"},{update:{method:"PUT"}})}function CampaignUsersService($resource){return $resource("api/campaign-users/:campaignId/:campaignUserId",{campaignId:"@campaignId",campaignUserId:"@_id"},{update:{method:"PUT"}})}angular.module("campaigns").factory("CampaignsService",CampaignsService).factory("CampaignUsersService",CampaignUsersService),CampaignsService.$inject=["$resource"],CampaignUsersService.$inject=["$resource"]}(),function(){function CanonicalsService($resource){return $resource("api/canonicals/:canonicalId",{canonicalId:"@_id"},{update:{method:"PUT"}})}angular.module("canonicals").factory("CanonicalsService",CanonicalsService),CanonicalsService.$inject=["$resource"]}(),function(){function CommonActionsService($resource){return $resource("api/common-actions/:commonActionId",{commonActionId:"@_id"},{update:{method:"PUT"}})}angular.module("common-actions").factory("CommonActionsService",CommonActionsService),CommonActionsService.$inject=["$resource"]}(),function(){function ConceptsService($resource){return $resource("api/concepts/:conceptId",{conceptId:"@_id"},{update:{method:"PUT"}})}angular.module("concepts").factory("ConceptsService",ConceptsService),ConceptsService.$inject=["$resource"]}(),function(){function CoreUtils(popup){return{getFullAddress:function(data){var fullAddr="",extraAddr="";return fullAddr="R"===data.userSelectedType?data.roadAddress:data.addressJibun,"R"===data.userSelectedType&&(""!==data.bname&&(extraAddr+=data.bname),""!==data.buildingName&&(extraAddr+=""!==extraAddr?", "+data.buildingName:data.buildingName),fullAddr+=""!==extraAddr?" ("+extraAddr+")":""),fullAddr},changeDateStrToDate:function(model){model.created&&"string"==typeof model.created&&(model.created=new Date(model.created)),model.startDate&&"string"==typeof model.startDate&&(model.startDate=new Date(model.startDate)),model.endDate&&"string"==typeof model.endDate&&(model.endDate=new Date(model.endDate)),model.moneyEndDate&&"string"==typeof model.moneyEndDate&&(model.moneyEndDate=new Date(model.moneyEndDate)),model.issueExpectDate&&"string"==typeof model.issueExpectDate&&(model.issueExpectDate=new Date(model.issueExpectDate)),model.cpBirth&&"string"==typeof model.cpBirth&&(model.cpBirth=new Date(model.cpBirth)),model.issueCompleteDate&&"string"==typeof model.issueCompleteDate&&(model.issueCompleteDate=new Date(model.issueCompleteDate)),model.updated&&"string"==typeof model.updated&&(model.updated=new Date(model.updated)),model.resetPasswordExpires&&"string"==typeof model.resetPasswordExpires&&(model.resetPasswordExpires=new Date(model.resetPasswordExpires)),model.confirmEmailExpires&&"string"==typeof model.confirmEmailExpires&&(model.confirmEmailExpires=new Date(model.confirmEmailExpires))},showConfirmAlert:function(message,callback){popup.open({backdrop:"static",templateUrl:"modules/core/client/views/show-alert.modal.client.view.html",controller:"AlertController",resolve:{resolve:function(){return{message:message,callback:callback,yesText:void 0,noText:void 0}}}})},showYesOrNoAlert:function(message,callback,yesText,noText){popup.open({backdrop:"static",templateUrl:"modules/core/client/views/show-alert.modal.client.view.html",controller:"AlertController",resolve:{resolve:function(){return{message:message,callback:callback,yesText:yesText?yesText:"예",noText:noText?noText:"아니오"}}}})}}}angular.module("core").factory("CoreUtils",CoreUtils).filter("propsFilter",function(){return function(items,props){var out=[];if(angular.isArray(items)){var keys=Object.keys(props);items.forEach(function(item){for(var itemMatches=!1,i=0;i<keys.length;i++){var prop=keys[i],text=props[prop].toLowerCase();if(item[prop].toString().toLowerCase().indexOf(text)!==-1){itemMatches=!0;break}}itemMatches&&out.push(item)})}else out=items;return out}}),CoreUtils.$inject=["$uibModal"]}(),angular.module("core").service("Menus",[function(){this.defaultRoles=["user","admin"],this.menus={};var shouldRender=function(user){if(~this.roles.indexOf("*"))return!0;if(!user)return!1;for(var userRoleIndex in user.roles)for(var roleIndex in this.roles)if(this.roles[roleIndex]===user.roles[userRoleIndex])return!0;return!1};this.validateMenuExistance=function(menuId){if(menuId&&menuId.length){if(this.menus[menuId])return!0;throw new Error("Menu does not exist")}throw new Error("MenuId was not provided")},this.getMenu=function(menuId){return this.validateMenuExistance(menuId),this.menus[menuId]},this.addMenu=function(menuId,options){return options=options||{},this.menus[menuId]={roles:options.roles||this.defaultRoles,items:options.items||[],shouldRender:shouldRender},this.menus[menuId]},this.removeMenu=function(menuId){this.validateMenuExistance(menuId),delete this.menus[menuId]},this.addMenuItem=function(menuId,options){if(options=options||{},this.validateMenuExistance(menuId),this.menus[menuId].items.push({title:options.title||"",state:options.state||"",type:options.type||"item",class:options.class,roles:null===options.roles||void 0===options.roles?this.defaultRoles:options.roles,position:options.position||0,items:[],shouldRender:shouldRender}),options.items)for(var i in options.items)this.addSubMenuItem(menuId,options.state,options.items[i]);return this.menus[menuId]},this.addSubMenuItem=function(menuId,parentItemState,options){options=options||{},this.validateMenuExistance(menuId);for(var itemIndex in this.menus[menuId].items)this.menus[menuId].items[itemIndex].state===parentItemState&&this.menus[menuId].items[itemIndex].items.push({title:options.title||"",state:options.state||"",roles:null===options.roles||void 0===options.roles?this.menus[menuId].items[itemIndex].roles:options.roles,position:options.position||0,shouldRender:shouldRender});return this.menus[menuId]},this.removeMenuItem=function(menuId,menuItemState){this.validateMenuExistance(menuId);for(var itemIndex in this.menus[menuId].items)this.menus[menuId].items[itemIndex].state===menuItemState&&this.menus[menuId].items.splice(itemIndex,1);return this.menus[menuId]},this.removeSubMenuItem=function(menuId,submenuItemState){this.validateMenuExistance(menuId);for(var itemIndex in this.menus[menuId].items)for(var subitemIndex in this.menus[menuId].items[itemIndex].items)this.menus[menuId].items[itemIndex].items[subitemIndex].state===submenuItemState&&this.menus[menuId].items[itemIndex].items.splice(subitemIndex,1);return this.menus[menuId]},this.addMenu("topbar",{roles:["*"]})}]),angular.module("core").service("Socket",["Authentication","$state","$timeout",function(Authentication,$state,$timeout){this.connect=function(){this.socket=io()},this.connect(),this.on=function(eventName,callback){this.socket&&this.socket.on(eventName,function(data){$timeout(function(){callback(data)})})},this.emit=function(eventName,data){this.socket&&this.socket.emit(eventName,data)},this.removeListener=function(eventName){this.socket&&this.socket.removeListener(eventName)}}]),function(){function CustomActionsService($resource){return $resource("api/custom-actions/:customActionId",{customActionId:"@_id"},{update:{method:"PUT"}})}angular.module("custom-actions").factory("CustomActionsService",CustomActionsService),CustomActionsService.$inject=["$resource"]}(),function(){function DeliveryOrderMenusService($resource){return $resource("api/deliveryOrders/:deliveryOrderId/menus",{deliveryOrderId:"@deliveryOrder"},{update:{method:"PUT"}})}angular.module("deliveryOrders").factory("DeliveryOrderMenusService",DeliveryOrderMenusService),DeliveryOrderMenusService.$inject=["$resource"]}(),function(){function DeliveryOrdersService($resource){return $resource("api/deliveryOrders/:deliveryOrderId",{deliveryOrderId:"@_id"},{update:{method:"PUT"}})}angular.module("deliveryOrders").factory("DeliveryOrdersService",DeliveryOrdersService),DeliveryOrdersService.$inject=["$resource"]}(),function(){function DialogsetsService($resource){return $resource("api/dialogsets/:dialogsetId",{dialogsetId:"@_id"},{update:{method:"PUT"}})}function DialogsetDialogsService($resource){return $resource("api/dialogsets/:dialogsetId/dialogs/:dialogId",{dialogsetId:"@dialogset",dialogId:"@_id"},{update:{method:"PUT"}})}angular.module("dialogsets").factory("DialogsetsService",DialogsetsService),DialogsetsService.$inject=["$resource"],angular.module("dialogsets").factory("DialogsetDialogsService",DialogsetDialogsService),DialogsetDialogsService.$inject=["$resource"]}(),function(){function DictsService($resource){return $resource("api/dicts/:dictId",{dictId:"@_id"},{update:{method:"PUT"}})}angular.module("dicts").factory("DictsService",DictsService),DictsService.$inject=["$resource"]}(),function(){function FactsService($resource){return $resource("api/facts/:factId",{factId:"@_id"},{update:{method:"PUT"}})}function FactsAtomService($resource){return $resource("api/factAtoms/:factId",{factId:"@_id"},{update:{method:"PUT"}})}function FactsLinkService($resource){return $resource("api/factLinks/:factId",{factId:"@_id"},{update:{method:"PUT"}})}angular.module("facts").factory("FactsService",FactsService),FactsService.$inject=["$resource"],angular.module("facts").factory("FactAtomsService",FactsService),FactsAtomService.$inject=["$resource"],angular.module("facts").factory("FactLinksService",FactsService),FactsLinkService.$inject=["$resource"]}(),function(){function FaqsService($resource){return $resource("api/faqs/:faqId",{faqId:"@_id"},{update:{method:"PUT"}})}angular.module("faqs").factory("FaqsService",FaqsService),FaqsService.$inject=["$resource"]}(),function(){function FranchiseMenusService($resource){return $resource("api/franchises/:franchiseId/menus",{franchiseId:"@franchise"},{update:{method:"PUT"}})}angular.module("franchises").factory("FranchiseMenusService",FranchiseMenusService),FranchiseMenusService.$inject=["$resource"]}(),function(){function FranchisesService($resource){return $resource("api/franchises/:franchiseId",{franchiseId:"@_id"},{update:{method:"PUT"}})}angular.module("franchises").factory("FranchisesService",FranchisesService),FranchisesService.$inject=["$resource"]}(),angular.module("learnings").factory("Learnings",["$resource",function($resource){return $resource("api/learnings/:learningId",{learningId:"@_id"},{update:{method:"PUT"}})}]),function(){function MessagesService($resource){return $resource("api/messages/:messageId",{messageId:"@_id"},{update:{method:"PUT"}})}angular.module("messages").factory("MessagesService",MessagesService),MessagesService.$inject=["$resource"]}(),angular.module("messengers").factory("Messengers",["$resource",function($resource){return $resource("api/messengers/:messengerId",{messengerId:"@_id"},{update:{method:"PUT"}})}]),angular.module("messengers").service("Socket",["Authentication","$state","$timeout",function(Authentication,$state,$timeout){this.connect=function(){this.socket=io()},this.connect(),this.on=function(eventName,callback){this.socket&&this.socket.on(eventName,function(data){$timeout(function(){callback(data)})})},this.emit=function(eventName,data){this.socket&&this.socket.emit(eventName,data)},this.removeListener=function(eventName){this.socket&&this.socket.removeListener(eventName)}}]),function(){function ProductsService($resource){return $resource("api/products/:productId",{productId:"@_id"},{update:{method:"PUT"}})}angular.module("products").factory("ProductsService",ProductsService),ProductsService.$inject=["$resource"]}(),function(){function MenusService($resource){return $resource("api/restaurants/:restaurantId/menus",{restaurantId:"@restaurant"},{update:{method:"PUT"}})}angular.module("restaurants").factory("MenusService",MenusService),MenusService.$inject=["$resource"]}(),function(){function RestaurantsService($resource){return $resource("api/restaurants/:restaurantId",{restaurantId:"@_id"},{update:{method:"PUT"}})}angular.module("restaurants").factory("RestaurantsService",RestaurantsService),RestaurantsService.$inject=["$resource"]}(),function(){function UserDialogsService($resource){return $resource("api/user-dialogs/:botId/:userKey",{userKey:"@_id"},{})}angular.module("user-dialogs").factory("UserDialogsService",UserDialogsService),UserDialogsService.$inject=["$resource"]}(),angular.module("users").factory("Authentication",["$window",function($window){return{user:$window.user}}]),angular.module("users").factory("PasswordValidator",["$window",function($window){var owaspPasswordStrengthTest=$window.owaspPasswordStrengthTest;return{getResult:function(password){return owaspPasswordStrengthTest.test(password)},getPopoverMsg:function(){return"Please enter a passphrase or password with greater than 10 characters, numbers, lowercase, upppercase, and special characters."}}}]),angular.module("users").factory("Users",["$resource",function($resource){return $resource("api/users",{},{update:{method:"PUT"}})}]),angular.module("users.admin").factory("Admin",["$resource",function($resource){return $resource("api/users/:userId",{userId:"@_id"},{update:{method:"PUT"}})}]),angular.module("core").directive("showErrors",["$timeout","$interpolate",function($timeout,$interpolate){var linkFn=function(scope,el,attrs,formCtrl){var inputEl,inputName,inputNgEl,options,showSuccess,toggleClasses,initCheck=!1,showValidationMessages=!1;if(options=scope.$eval(attrs.showErrors)||{},showSuccess=options.showSuccess||!1,inputEl=el[0].querySelector(".form-control[name]")||el[0].querySelector("[name]"),inputNgEl=angular.element(inputEl),!(inputName=$interpolate(inputNgEl.attr("name")||"")(scope)))throw"show-errors element has no child input elements with a 'name' attribute class";var reset=function(){return $timeout(function(){el.removeClass("has-error"),el.removeClass("has-success"),showValidationMessages=!1},0,!1)};scope.$watch(function(){return formCtrl[inputName]&&formCtrl[inputName].$invalid},function(invalid){return toggleClasses(invalid)}),scope.$on("show-errors-check-validity",function(event,name){if(angular.isUndefined(name)||formCtrl.$name===name)return initCheck=!0,showValidationMessages=!0,toggleClasses(formCtrl[inputName].$invalid)}),scope.$on("show-errors-reset",function(event,name){if(angular.isUndefined(name)||formCtrl.$name===name)return reset()}),toggleClasses=function(invalid){if(el.toggleClass("has-error",showValidationMessages&&invalid),showSuccess)return el.toggleClass("has-success",showValidationMessages&&!invalid)}};return{restrict:"A",require:"^form",compile:function(elem,attrs){if(attrs.showErrors.indexOf("skipFormGroupCheck")===-1&&!elem.hasClass("form-group")&&!elem.hasClass("input-group"))throw"show-errors element does not have the 'form-group' or 'input-group' class";return linkFn}}}]),angular.module("users").directive("passwordValidator",["PasswordValidator",function(PasswordValidator){return{require:"ngModel",link:function(scope,element,attrs,ngModel){ngModel.$validators.requirements=function(password){var status=!0;if(password){var result=PasswordValidator.getResult(password),requirementsIdx=0,requirementsMeter=[{color:"danger",progress:"20"},{color:"warning",progress:"40"},{color:"info",progress:"60"},{color:"primary",progress:"80"},{color:"success",progress:"100"}];result.errors.length<requirementsMeter.length&&(requirementsIdx=requirementsMeter.length-result.errors.length-1),scope.requirementsColor=requirementsMeter[requirementsIdx].color,scope.requirementsProgress=requirementsMeter[requirementsIdx].progress,result.errors.length?(scope.popoverMsg=PasswordValidator.getPopoverMsg(),scope.passwordErrors=result.errors,status=!1):(scope.popoverMsg="",scope.passwordErrors=[],status=!0)}return status}}}}]),angular.module("users").directive("passwordVerify",[function(){return{require:"ngModel",scope:{passwordVerify:"="},link:function(scope,element,attrs,ngModel){scope.$watch(function(){var combined;return(scope.passwordVerify||ngModel)&&(combined=scope.passwordVerify+"_"+ngModel),combined},function(value){value&&(ngModel.$validators.passwordVerify=function(password){return scope.passwordVerify===password})})}}}]),angular.module("users").directive("lowercase",function(){return{require:"ngModel",link:function(scope,element,attrs,modelCtrl){modelCtrl.$parsers.push(function(input){return input?input.toLowerCase():""}),element.css("text-transform","lowercase")}}}),angular.module("core").factory("authInterceptor",["$q","$injector",function($q,$injector){return{responseError:function(rejection){if(!rejection.config.ignoreAuthModule)switch(rejection.status){case 401:$injector.get("$state").transitionTo("authentication.signin");break;case 403:$injector.get("$state").transitionTo("forbidden")}return $q.reject(rejection)}}}]),angular.module("users.admin").controller("UserListController",["$scope","$filter","Admin",function($scope,$filter,Admin){Admin.query(function(data){$scope.users=data,$scope.buildPager()}),$scope.buildPager=function(){$scope.pagedItems=[],$scope.itemsPerPage=15,$scope.currentPage=1,$scope.figureOutItemsToDisplay()},$scope.figureOutItemsToDisplay=function(){$scope.filteredItems=$filter("filter")($scope.users,{$:$scope.search}),$scope.filterLength=$scope.filteredItems.length;var begin=($scope.currentPage-1)*$scope.itemsPerPage,end=begin+$scope.itemsPerPage;$scope.pagedItems=$scope.filteredItems.slice(begin,end)},$scope.pageChanged=function(){$scope.figureOutItemsToDisplay()}}]),angular.module("users.admin").controller("UserController",["$scope","$state","Authentication","userResolve",function($scope,$state,Authentication,userResolve){$scope.authentication=Authentication,$scope.user=userResolve,$scope.remove=function(user){confirm("Are you sure you want to delete this user?")&&(user?(user.$remove(),$scope.users.splice($scope.users.indexOf(user),1)):$scope.user.$remove(function(){$state.go("admin.users")}))},$scope.update=function(isValid){if(!isValid)return $scope.$broadcast("show-errors-check-validity","userForm"),!1;var user=$scope.user;user.$update(function(){$state.go("admin.user",{userId:user._id})},function(errorResponse){$scope.error=errorResponse.data.message})}}]),angular.module("users").controller("ChangePasswordController",["$scope","$http","Authentication","PasswordValidator",function($scope,$http,Authentication,PasswordValidator){$scope.user=Authentication.user,$scope.popoverMsg=PasswordValidator.getPopoverMsg(),$scope.changeUserPassword=function(isValid){if($scope.success=$scope.error=null,$scope.submitted=!0,!isValid)return $scope.$broadcast("show-errors-check-validity","passwordForm"),!1;$http.post("/api/users/password",$scope.passwordDetails).success(function(response){$scope.$broadcast("show-errors-reset","passwordForm"),$scope.success=!0,$scope.passwordDetails=null}).error(function(response){$scope.error=response.message})}}]),angular.module("users").controller("ChangeProfilePictureController",["$scope","$timeout","$window","Authentication","FileUploader",function($scope,$timeout,$window,Authentication,FileUploader){$scope.user=Authentication.user,$scope.imageURL=$scope.user.profileImageURL,$scope.uploader=new FileUploader({url:"api/users/picture",alias:"newProfilePicture"}),$scope.uploader.filters.push({name:"imageFilter",fn:function(item,options){var type="|"+item.type.slice(item.type.lastIndexOf("/")+1)+"|";return"|jpg|png|jpeg|bmp|gif|".indexOf(type)!==-1}}),$scope.uploader.onAfterAddingFile=function(fileItem){if($window.FileReader){var fileReader=new FileReader;fileReader.readAsDataURL(fileItem._file),fileReader.onload=function(fileReaderEvent){$timeout(function(){$scope.imageURL=fileReaderEvent.target.result},0)}}},$scope.uploader.onSuccessItem=function(fileItem,response,status,headers){$scope.success=!0,$scope.user=Authentication.user=response,$scope.cancelUpload()},$scope.uploader.onErrorItem=function(fileItem,response,status,headers){$scope.cancelUpload(),$scope.error=response.message},$scope.uploadProfilePicture=function(){$scope.success=$scope.error=null,$scope.uploader.uploadAll()},$scope.cancelUpload=function(){$scope.uploader.clearQueue(),$scope.imageURL=$scope.user.profileImageURL}}]),angular.module("users").controller("EditProfileController",["$scope","$http","$location","Users","Authentication",function($scope,$http,$location,Users,Authentication){$scope.user=Authentication.user,$scope.updateUserProfile=function(isValid){if($scope.success=$scope.error=null,!isValid)return $scope.$broadcast("show-errors-check-validity","userForm"),!1;new Users($scope.user).$update(function(response){$scope.$broadcast("show-errors-reset","userForm"),$scope.success=!0,Authentication.user=response},function(response){$scope.error=response.data.message})}}]),angular.module("users").controller("SocialAccountsController",["$scope","$http","Authentication",function($scope,$http,Authentication){$scope.user=Authentication.user,$scope.hasConnectedAdditionalSocialAccounts=function(provider){for(var i in $scope.user.additionalProvidersData)return!0;return!1},$scope.isConnectedSocialAccount=function(provider){return $scope.user.provider===provider||$scope.user.additionalProvidersData&&$scope.user.additionalProvidersData[provider]},$scope.removeUserSocialAccount=function(provider){$scope.success=$scope.error=null,$http.delete("/api/users/accounts",{params:{provider:provider}}).success(function(response){$scope.success=!0,$scope.user=Authentication.user=response}).error(function(response){$scope.error=response.message})}}]),angular.module("users").controller("SettingsController",["$scope","Authentication",function($scope,Authentication){$scope.user=Authentication.user}]);